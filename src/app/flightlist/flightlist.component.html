<div class="flight-list-wrapper" *ngIf="isBrowser">
  <!-- Shimmer Loading -->
  <div *ngIf="loader">
    <main class="shimmer-main">
      <div class="shimmer-box-long"></div>
      <p></p>
      <div class="shimmer-box-long1"></div>
      <br />
      <div>
        <div class="shimmer-grid">
          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-circle"></div>
              <div class="shimmer-box1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>

          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-circle"></div>
              <div class="shimmer-box1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>
        </div>
        <br />
        <div class="shimmer-box-long2"></div>
        <br />
        <div class="shimmer-grid">
          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>

          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>
        </div>
        <br />
        <div class="shimmer-box-long1"></div>
        <div class="shimmer-grid">
          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long"></div>
            </div>
          </div>

          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long"></div>
            </div>
          </div>
        </div>
        <div class="shimmer-box-long2"></div>
        <div class="shimmer-grid">
          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>

          <div class="container">
            <div class="flex-container-space-between">
              <div class="shimmer-box-long1"></div>
            </div>
            <div class="shimmer-box"></div>
          </div>
        </div>
        <br />
        <div class="shimmer-box-long"></div>
      </div>
    </main>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loader">
    <!-- Search Summary Bar (matching booking-results design) -->
    <div class="search-summary" [class.sticky]="isHeaderSticky" *ngIf="flightInputData">
      <div class="container">
        <div class="summary-content">
          <div class="summary-info">
            <div class="route-summary">
              <!-- Multi-City Route Display -->
              <div class="route-locations multicity-route-display" *ngIf="flightType === 'multi' && multicityTabData && multicityTabData.length > 0">
                <div class="multicity-segment-item" *ngFor="let segment of multicityTabData; let i = index">
                  <div class="location-group">
                    <span class="from">{{ getMultiCityRouteOrigin(i) }}</span>
                  </div>
                  <i class="fas fa-plane"></i>
                  <div class="location-group">
                    <span class="to">{{ getMultiCityRouteDestination(i) }}</span>
                  </div>
                  <span class="segment-date" *ngIf="getMultiCityRouteDate(i)">{{ getMultiCityRouteDate(i) | date : "d MMM" }}</span>
                  <span class="segment-separator" *ngIf="i < multicityTabData.length - 1">
                    <i class="fas fa-arrow-right"></i>
                  </span>
                </div>
              </div>
              <!-- One-Way / Round-Trip Route Display -->
              <div class="route-locations" *ngIf="flightType !== 'multi'">
                <div class="location-group">
                  <span class="from">{{ flightInputData['fromCity'] || flightInputData['fromAirport'] }}</span>
                  <span class="location-detail" *ngIf="flightInputData['fromAirportCode']">({{
                    flightInputData['fromAirportCode'] }})</span>
                </div>
                <i class="fas fa-arrow-right"></i>
                <div class="location-group">
                  <span class="to">{{ flightInputData['toCity'] || flightInputData['toAirport'] }}</span>
                  <span class="location-detail" *ngIf="flightInputData['toAirportCode']">({{
                    flightInputData['toAirportCode'] }})</span>
                </div>
              </div>
              <div class="journey-details">
                <span class="date" *ngIf="flightType !== 'multi'">{{ flightInputData['departureDate'] | date : "d MMM, yyyy" }}</span>
                <span class="date" *ngIf="flightType === 'round' && flightInputData['returnDate']">{{
                  flightInputData['returnDate'] | date : "d MMM, yyyy" }}</span>
                <span class="passengers">{{ totalPassengers }} {{ totalPassengers > 1 ? 'Passengers' : 'Passenger'
                  }}</span>
                <span class="passengers" *ngIf="modifySearchForm.get('travelClass')?.value">{{
                  modifySearchForm.get('travelClass')?.value }}</span>
              </div>
            </div>
          </div>
          <div class="summary-actions">
            <button class="modify-btn" (click)="showModifyForm = !showModifyForm" title="Modify">
              <i class="fas fa-edit"></i>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modify Search Form (Desktop - Collapsible) -->
    <div class="modify-search-section desktop-modify-form" [class.visible]="showModifyForm">
      <div class="container">
        <form [formGroup]="modifySearchForm" (ngSubmit)="onModifySearch()" class="modify-search-form">
          <div class="form-row">
            <div class="form-group">
              <label>From:</label>
              <!-- Typable airport input with suggestions -->
              <input type="text" formControlName="from" list="airportList"
                placeholder="Type city or airport (e.g. Delhi, DEL)" />
            </div>
            <div class="form-group">
              <label>To:</label>
              <!-- Typable airport input with suggestions -->
              <input type="text" formControlName="to" list="airportList"
                placeholder="Type city or airport (e.g. Mumbai, BOM)" />
            </div>
            <!-- Shared datalist for airport suggestions -->
            <datalist id="airportList">
              <option *ngFor="let city of flightAirports" [value]="city.code">
                {{ city.name }} ({{ city.code }})
              </option>
            </datalist>
            <div class="form-group">
              <label>Departure Date:</label>
              <input type="date" formControlName="departureDate" />
            </div>
            <div class="form-group" *ngIf="flightType === 'round'">
              <label>Return Date:</label>
              <input type="date" formControlName="returnDate" />
            </div>
            <div class="form-group passenger-dropdown-wrapper">
              <label>Passengers:</label>
              <div class="passenger-display" (click)="togglePassengerDropdown(); $event.stopPropagation()">
                {{ totalPassengers }} Passenger{{ totalPassengers > 1 ? "s" : "" }}
                <i class="fas fa-chevron-down" [class.rotated]="showPassengerDropdown"></i>
              </div>
              <div class="passenger-dropdown" *ngIf="showPassengerDropdown" (click)="$event.stopPropagation()">
                <div class="passenger-type-row" *ngFor="let type of passengerTypes">
                  <div class="label">{{ type.label }}</div>
                  <div class="controls">
                    <button type="button" (click)="decrement(type.key)">−</button>
                    <span>{{ modifySearchForm.get(type.key)?.value }}</span>
                    <button type="button" (click)="increment(type.key)">+</button>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-group">
              <label>Class:</label>
              <select formControlName="travelClass">
                <option value="">Select class</option>
                <option *ngFor="let cls of travelClasses" [value]="cls">{{ cls }}</option>
              </select>
            </div>
            <div class="form-group">
              <button type="submit" class="modify-search-btn">Modify Search</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Mobile Modify Search Drawer (Slides from left) -->
    <div class="mobile-modify-drawer" [class.open]="showModifyForm" (click)="showModifyForm = false">
      <div class="mobile-modify-drawer-content" (click)="$event.stopPropagation()">
        <button class="mobile-modify-drawer-close" (click)="showModifyForm = false">×</button>
        <div class="mobile-modify-drawer-header">
          <h2>Modify Search</h2>
        </div>
        <form [formGroup]="modifySearchForm" (ngSubmit)="onModifySearch()" class="mobile-modify-search-form">
          <div class="mobile-form-group">
            <label>From:</label>
            <input type="text" formControlName="from" list="airportListMobile"
              placeholder="Type city or airport (e.g. Delhi, DEL)" />
          </div>
          <div class="mobile-form-group">
            <label>To:</label>
            <input type="text" formControlName="to" list="airportListMobile"
              placeholder="Type city or airport (e.g. Mumbai, BOM)" />
          </div>
          <!-- Shared datalist for airport suggestions -->
          <datalist id="airportListMobile">
            <option *ngFor="let city of flightAirports" [value]="city.code">
              {{ city.name }} ({{ city.code }})
            </option>
          </datalist>
          <div class="mobile-form-group">
            <label>Departure Date:</label>
            <input type="date" formControlName="departureDate" />
          </div>
          <div class="mobile-form-group" *ngIf="flightType === 'round'">
            <label>Return Date:</label>
            <input type="date" formControlName="returnDate" />
          </div>
          <div class="mobile-form-group mobile-passenger-dropdown-wrapper">
            <label>Passengers:</label>
            <div class="mobile-passenger-display" (click)="togglePassengerDropdown(); $event.stopPropagation()">
              {{ totalPassengers }} Passenger{{ totalPassengers > 1 ? "s" : "" }}
              <i class="fas fa-chevron-down" [class.rotated]="showPassengerDropdown"></i>
            </div>
            <div class="mobile-passenger-dropdown" *ngIf="showPassengerDropdown" (click)="$event.stopPropagation()">
              <div class="mobile-passenger-type-row" *ngFor="let type of passengerTypes">
                <div class="label">{{ type.label }}</div>
                <div class="controls">
                  <button type="button" (click)="decrement(type.key)">−</button>
                  <span>{{ modifySearchForm.get(type.key)?.value }}</span>
                  <button type="button" (click)="increment(type.key)">+</button>
                </div>
              </div>
            </div>
          </div>
          <div class="mobile-form-group">
            <label>Class:</label>
            <select formControlName="travelClass">
              <option value="">Select class</option>
              <option *ngFor="let cls of travelClasses" [value]="cls">{{ cls }}</option>
            </select>
          </div>
          <div class="mobile-form-group">
            <button type="submit" class="mobile-modify-search-btn">Modify Search</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Main Content Area -->
    <main class="results-main">
      <div class="container">
        <!-- Date Slider spanning sidebar and results -->
        <div class="date-slider-bar" *ngIf="flightType === 'oneway'">
          <div class="date-slider-wrapper">
            <div class="date-slider-scroll-wrapper" #scrollContainer>
              <div class="date-slider-container">
                <div class="date-card" *ngFor="let item of datePrices; let i = index"
                  [class.selected]="item.date === highlightedDate" [class.no-price]="item.price === 0 || !item.price"
                  (click)="selectDateFromSlider(item.date, i)">
                  <div class="date-label">{{ item.date | date : "d MMM" }}</div>
                  <div class="date-price" *ngIf="item.price > 0">₹ {{ item.price | number : "1.2-2" }}</div>
                  <div class="date-price no-price-text" *ngIf="item.price === 0 || !item.price">N/A</div>
                </div>
                <div *ngIf="datePrices.length === 0" class="date-slider-empty">
                  Loading date prices...
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mobile Filter Chips and Button (only visible on mobile) -->
        <div class="mobile-filter-chips-wrapper" *ngIf="flightType === 'oneway' || flightType === 'round' || flightType === 'multi'">
          <div class="mobile-filter-chips">
            <button class="mobile-filter-chip" [class.active]="selectedStops.includes(0)"
              (click)="toggleNonStopFilter()">
              Non Stop
            </button>
            <button class="mobile-filter-chip" [class.active]="showRefundableOnly" (click)="toggleRefundableFilter()">
              Refundable
            </button>
            <button class="mobile-filter-chip" [class.active]="selectedAirlines.length > 0"
              (click)="showMobileFilter = true; mobileFilterActiveTab = 'filter'">
              Airlines
            </button>
          </div>
          <button class="mobile-filter-icon-btn" (click)="showMobileFilter = !showMobileFilter">
            <i class="fas fa-sliders-h"></i>
          </button>
        </div>

        <!-- Mobile Filter Popup -->
        <div class="mobile-filter-backdrop" *ngIf="showMobileFilter" (click)="showMobileFilter = false"></div>
        <div class="mobile-filter-popup" [class.active]="showMobileFilter" *ngIf="showMobileFilter">
          <div class="mobile-filter-content" (click)="$event.stopPropagation()">
            <div class="mobile-filter-header">
              <span class="title">Refine Your Search</span>
              <button class="mobile-filter-close-btn" (click)="showMobileFilter = false">&times;</button>
            </div>

            <div class="mobile-filter-tabs">
              <span class="mobile-filter-tab" [class.highlighted]="mobileFilterActiveTab === 'sort'"
                (click)="mobileFilterActiveTab = 'sort'">Sort</span>
              <span class="mobile-filter-tab" [class.highlighted]="mobileFilterActiveTab === 'filter'"
                (click)="mobileFilterActiveTab = 'filter'">Filter</span>
            </div>

            <!-- Sort Section -->
            <div *ngIf="mobileFilterActiveTab === 'sort'" class="mobile-filter-section">
              <div class="mobile-filter-block">
                <label class="mobile-filter-block-title">Sort By</label>
                <div class="mobile-checkbox-row" *ngFor="let sortOption of sortOptions || []">
                  <input type="radio" name="mobileSort" [value]="sortOption" [checked]="selectedSort === sortOption"
                    (change)="selectedSort = sortOption; applySort()" />
                  <label>{{ sortOption }}</label>
                </div>
              </div>
            </div>

            <!-- Filter Section -->
            <div *ngIf="mobileFilterActiveTab === 'filter'" class="mobile-filter-section">
              <!-- Stops Filter -->
              <div class="mobile-filter-block" *ngIf="dynamicFilters?.stops && dynamicFilters.stops.length > 0">
                <label class="mobile-filter-block-title">Stops</label>
                <div class="mobile-checkbox-wrap">
                  <label class="mobile-checkbox-inline" *ngFor="let stop of dynamicFilters?.stops || []">
                    <input type="checkbox" [value]="stop" (change)="onStopFilterChange($event)"
                      [checked]="selectedStops.includes(stop)" />
                    {{ stop === 0 ? "Non-stop" : stop + " Stop" + (stop > 1 ? "s" : "") }}
                  </label>
                </div>
              </div>
              <hr class="mobile-filter-hr" *ngIf="dynamicFilters?.stops && dynamicFilters.stops.length > 0" />

              <!-- Airlines Filter -->
              <div class="mobile-filter-block" *ngIf="dynamicFilters?.airlines && dynamicFilters.airlines.length > 0">
                <label class="mobile-filter-block-title">Airlines</label>
                <div class="mobile-checkbox-wrap">
                  <label class="mobile-checkbox-inline" *ngFor="let airline of dynamicFilters?.airlines || []">
                    <input type="checkbox" [value]="airline" (change)="onAirlineFilterChange($event)"
                      [checked]="selectedAirlines.includes(airline)" />
                    {{ airline }}
                  </label>
                </div>
              </div>
              <hr class="mobile-filter-hr" *ngIf="dynamicFilters?.airlines && dynamicFilters.airlines.length > 0" />

              <!-- Refundability Filter -->
              <div class="mobile-filter-block">
                <label class="mobile-filter-block-title">Refundable</label>
                <div class="mobile-checkbox-wrap">
                  <label class="mobile-checkbox-inline">
                    <input type="checkbox" [(ngModel)]="showRefundableOnly" />
                    Only Refundable
                  </label>
                </div>
              </div>
              <hr class="mobile-filter-hr" />

              <!-- Departure Timings Filter -->
              <div class="mobile-filter-block" *ngIf="departureTimeSlots && departureTimeSlots.length > 0">
                <label class="mobile-filter-block-title">Departure Timings</label>
                <div class="mobile-departure-time-filter">
                  <div class="mobile-time-slot" *ngFor="let slot of departureTimeSlots"
                    [class.selected]="slot?.label && selectedDepartureSlots?.has(slot.label)"
                    (click)="toggleDepartureSlot(slot?.label)">
                    <i [class]="slot?.iconClass"></i>
                    <div class="label">{{ slot?.label }}</div>
                  </div>
                </div>
              </div>

              <!-- Price Range Filter -->
              <div class="mobile-filter-block" *ngIf="dynamicFilters?.min_price && dynamicFilters?.max_price">
                <label class="mobile-filter-block-title">Price Range</label>
                <input type="range" [min]="dynamicFilters?.min_price || 0" [max]="dynamicFilters?.max_price || 0"
                  [(ngModel)]="priceRange" class="mobile-filter-price-range" (input)="onPriceChange()" />
                <div class="mobile-filter-price-range-label">
                  ₹{{ (dynamicFilters?.min_price || 0) | number : "1.0-0" }} - ₹{{ priceRange | number : "1.0-0" }}
                </div>
              </div>

              <div class="mobile-filter-button-row">
                <button class="mobile-filter-clear-btn" (click)="clearAllFilters()">
                  Clear All Filters
                </button>
                <button class="mobile-filter-apply-btn" (click)="applyMobileFilters()">
                  Apply Filter
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="results-layout">
          <!-- Filter Sidebar -->
          <div class="filter-sidebar-column" *ngIf="flightType === 'oneway'">
            <div class="filter-card">
              <h2 class="filter-heading">Filter Flights</h2>

              <!-- Airlines Filter -->
              <div class="filter-section">
                <h3 class="filter-subheading">Airlines</h3>
                <label class="filter-option" *ngFor="let airline of dynamicFilters.airlines">
                  <input type="checkbox" [value]="airline" (change)="onAirlineFilterChange($event)" />
                  {{ airline }}
                </label>
              </div>

              <!-- Price Range Filter -->
              <div class="filter-section">
                <h3 class="filter-subheading">Price Range</h3>
                <input type="range" [min]="dynamicFilters.min_price" [max]="dynamicFilters.max_price"
                  [(ngModel)]="priceRange" class="price-range" (input)="onPriceChange()" />
                <div class="price-range-label">
                  ₹{{ dynamicFilters.min_price | number : "1.0-0" }} - ₹{{ priceRange | number : "1.0-0" }}
                </div>
              </div>

              <!-- Number of Stops Filter -->
              <div class="filter-section">
                <h3 class="filter-subheading">Number of Stops</h3>
                <label class="filter-option" *ngFor="let stop of dynamicFilters.stops">
                  <input type="checkbox" [value]="stop" (change)="onStopFilterChange($event)" />
                  {{ stop === 0 ? "Non-stop" : stop + " Stop" + (stop > 1 ? "s" : "") }}
                </label>
              </div>

              <!-- Departure Time Filter -->
              <div class="filter-section">
                <h3 class="filter-subheading">Departure From {{ flightInputData['fromCity'] }}</h3>
                <div class="departure-time-filter">
                  <div class="time-slot" *ngFor="let slot of departureTimeSlots"
                    (click)="toggleDepartureSlot(slot.label)" [class.selected]="selectedDepartureSlots.has(slot.label)">
                    <i [class]="slot.iconClass"></i>
                    <div class="label">{{ slot.label }}</div>
                  </div>
                </div>
              </div>

              <!-- Refundability Filter -->
              <div class="filter-section">
                <h3 class="filter-subheading">Refundability</h3>
                <label class="filter-option">
                  <input type="checkbox" value="refundable" (change)="onRefundabilityChange($event)" />
                  Partially Refundable
                </label>
                <label class="filter-option">
                  <input type="checkbox" value="non-refundable" (change)="onRefundabilityChange($event)" />
                  Non-refundable
                </label>
              </div>
            </div>
          </div>

          <!-- Round Trip Filters -->
          <div class="filter-sidebar-column" *ngIf="flightType === 'round'">
            <div class="filter-card">
              <!-- Onward Filters -->
              <h2 class="filter-heading">Filter Onward Flights</h2>

              <!-- Airlines -->
              <div class="filter-section">
                <h3 class="filter-subheading">Airlines</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllAirlines('onward')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetAirlines('onward')">Reset</button>
                </div>
                <label class="filter-option" *ngFor="let airline of roundtripDynamicFiltersOnward.airlines">
                  <input type="checkbox" [value]="airline" (change)="roundtripOnAirlineFilterChange($event, 'onward')"
                    [checked]="roundtripSelectedAirlinesOnward.includes(airline)" />
                  {{ airline }}
                </label>
              </div>

              <!-- Price -->
              <div class="filter-section">
                <h3 class="filter-subheading">Price Range</h3>
                <input type="range" [min]="roundtripDynamicFiltersOnward.min_price"
                  [max]="roundtripDynamicFiltersOnward.max_price" [(ngModel)]="roundtripPriceRangeOnward"
                  class="price-range" (input)="roundtripOnPriceChange('onward')" />
                <div class="price-range-label">
                  ₹{{ roundtripDynamicFiltersOnward.min_price | number : "1.0-0" }} - ₹{{ roundtripPriceRangeOnward |
                  number : "1.0-0" }}
                </div>
              </div>

              <!-- Stops -->
              <div class="filter-section">
                <h3 class="filter-subheading">Number of Stops</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllStops('onward')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetStops('onward')">Reset</button>
                </div>
                <label class="filter-option" *ngFor="let stop of roundtripDynamicFiltersOnward.stops">
                  <input type="checkbox" [value]="stop" (change)="roundtripOnStopFilterChange($event, 'onward')"
                    [checked]="roundtripSelectedStopsOnward.includes(stop)" />
                  {{ stop === 0 ? "Non-stop" : stop + " Stop" + (stop > 1 ? "s" : "") }}
                </label>
              </div>

              <!-- Time -->
              <div class="filter-section">
                <h3 class="filter-subheading">Departure from {{ flightInputData['fromCity'] }}</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllDepartureSlots('onward')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetDepartureSlots('onward')">Reset</button>
                </div>
                <div class="departure-time-filter">
                  <div class="time-slot" *ngFor="let slot of departureTimeSlots"
                    (click)="roundtripToggleDepartureSlot(slot.label, 'onward')"
                    [class.selected]="roundtripSelectedDepartureSlotsOnward.has(slot.label)">
                    <i [class]="slot.iconClass"></i>
                    <div class="label">{{ slot.label }}</div>
                  </div>
                </div>
              </div>

              <!-- Refundability -->
              <div class="filter-section">
                <h3 class="filter-subheading">Refundability</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="selectAllRefundability('onward')">Select All</button>
                  <button class="btn-link danger" (click)="resetRefundability('onward')">Reset</button>
                </div>
                <label class="filter-option">
                  <input type="checkbox" [(ngModel)]="showRefundableOnward" (change)="roundtripApplyAllFilters()" />
                  Partially Refundable
                </label>
                <label class="filter-option">
                  <input type="checkbox" [(ngModel)]="showNonRefundableOnward" (change)="roundtripApplyAllFilters()" />
                  Non-refundable
                </label>
              </div>

              <hr />

              <!-- Return Filters -->
              <h2 class="filter-heading">Filter Return Flights</h2>

              <!-- Airlines -->
              <div class="filter-section">
                <h3 class="filter-subheading">Airlines</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllAirlines('return')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetAirlines('return')">Reset</button>
                </div>
                <label class="filter-option" *ngFor="let airline of roundtripDynamicFiltersReturn.airlines">
                  <input type="checkbox" [value]="airline" (change)="roundtripOnAirlineFilterChange($event, 'return')"
                    [checked]="roundtripSelectedAirlinesReturn.includes(airline)" />
                  {{ airline }}
                </label>
              </div>

              <!-- Price -->
              <div class="filter-section">
                <h3 class="filter-subheading">Price Range</h3>
                <input type="range" [min]="roundtripDynamicFiltersReturn.min_price"
                  [max]="roundtripDynamicFiltersReturn.max_price" [(ngModel)]="roundtripPriceRangeReturn"
                  class="price-range" (input)="roundtripOnPriceChange('return')" />
                <div class="price-range-label">
                  ₹{{ roundtripDynamicFiltersReturn.min_price | number : "1.0-0" }} - ₹{{ roundtripPriceRangeReturn |
                  number : "1.0-0" }}
                </div>
              </div>

              <!-- Stops -->
              <div class="filter-section">
                <h3 class="filter-subheading">Number of Stops</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllStops('return')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetStops('return')">Reset</button>
                </div>
                <label class="filter-option" *ngFor="let stop of roundtripDynamicFiltersReturn.stops">
                  <input type="checkbox" [value]="stop" (change)="roundtripOnStopFilterChange($event, 'return')"
                    [checked]="roundtripSelectedStopsReturn.includes(stop)" />
                  {{ stop === 0 ? "Non-stop" : stop + " Stop" + (stop > 1 ? "s" : "") }}
                </label>
              </div>

              <!-- Time -->
              <div class="filter-section">
                <h3 class="filter-subheading">Departure from {{ flightInputData['toCity'] }}</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="roundtripSelectAllDepartureSlots('return')">Select All</button>
                  <button class="btn-link danger" (click)="roundtripResetDepartureSlots('return')">Reset</button>
                </div>
                <div class="departure-time-filter">
                  <div class="time-slot" *ngFor="let slot of departureTimeSlots"
                    (click)="roundtripToggleDepartureSlot(slot.label, 'return')"
                    [class.selected]="roundtripSelectedDepartureSlotsReturn.has(slot.label)">
                    <i [class]="slot.iconClass"></i>
                    <div class="label">{{ slot.label }}</div>
                  </div>
                </div>
              </div>

              <!-- Refundability -->
              <div class="filter-section">
                <h3 class="filter-subheading">Refundability</h3>
                <div class="filter-buttons">
                  <button class="btn-link" (click)="selectAllRefundability('return')">Select All</button>
                  <button class="btn-link danger" (click)="resetRefundability('return')">Reset</button>
                </div>
                <label class="filter-option">
                  <input type="checkbox" [(ngModel)]="showRefundableReturn" (change)="roundtripApplyAllFilters()" />
                  Partially Refundable
                </label>
                <label class="filter-option">
                  <input type="checkbox" [(ngModel)]="showNonRefundableReturn" (change)="roundtripApplyAllFilters()" />
                  Non-refundable
                </label>
              </div>
            </div>
          </div>

          <!-- Left Column - Flight Results -->
          <div class="results-column">
            <!-- One Way Flights -->
            <div *ngIf="flightType === 'oneway'" class="flight-list-container">
              <!-- Debug Info (remove after testing) -->
              <!-- <div style="padding: 20px; background: #f0f0f0; margin: 10px 0;">
                <p>Debug: flightType = {{ flightType }}</p>
                <p>Debug: groupedFlights length = {{ groupedFlights?.length || 0 }}</p>
                <p>Debug: loader = {{ loader }}</p>
              </div> -->

              <!-- Flight Cards (matching booking-results card design) -->
              <div class="flight-cards" *ngIf="groupedFlights && groupedFlights.length > 0">
                <div class="card mobile-flight-card-new" [class.card-expanded]="flightDetailsExpanded[i]"
                  (click)="toggleCardExpansion(i, $event)" *ngFor="let flight of groupedFlights; let i = index">

                  <!-- DESKTOP SINGLE ROW LAYOUT -->
                  <div class="desktop-flight-row">
                    <!-- Airline Section -->
                    <div class="desktop-airline-section">
                      <img class="desktop-airline-logo"
                        [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                        [alt]="flight.Segments[0][0].Airline.AirlineName"
                        onerror="this.src='assets/images/default-airline.png'" />
                      <div class="desktop-airline-info">
                        <div class="desktop-airline-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                        <div class="desktop-flight-number">{{ flight.Segments[0][0].Airline.AirlineCode }} {{ flight.Segments[0][0].Airline.FlightNumber }}</div>
                        <div class="desktop-aircraft-type">{{ flight.Segments[0][0].Craft || 'Aircraft' }}</div>
                      </div>
                    </div>

                    <!-- Departure Section -->
                    <div class="desktop-departure-section">
                      <div class="desktop-time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }}</div>
                      <div class="desktop-date">{{ flight.Segments[0][0].Origin.DepTime | date : "EEE, dd MMM" }}</div>
                      <div class="desktop-airport">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                    </div>

                    <!-- Duration & Stops Section -->
                    <div class="desktop-duration-section">
                      <div class="desktop-duration-text">{{ getTotalDuration(flight.Segments[0]) }}</div>
                      <div class="desktop-stops-text">{{ getStopsCount(flight) === 0 ? 'Non Stop' : getStopsCount(flight) + ' Stop' + (getStopsCount(flight) > 1 ? 's' : '') }}</div>
                    </div>

                    <!-- Arrival Section -->
                    <div class="desktop-arrival-section">
                      <div class="desktop-time">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm" }}</div>
                      <div class="desktop-date">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "EEE, dd MMM" }}</div>
                      <div class="desktop-airport">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.Airport.CityName }}</div>
                      <div class="desktop-day-diff" *ngIf="getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) > 0">
                        +{{ getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) }} day
                      </div>
                    </div>

                    <!-- Price & Button Section -->
                    <div class="desktop-price-section">
                      <div class="desktop-price-amount">₹ {{ flight.price | number : "1.0-0" }}</div>
                      <div class="desktop-price-label">per Adult</div>
                      <button class="desktop-view-prices-btn" (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                        View Prices
                      </button>
                    </div>
                  </div>
                  <!-- END DESKTOP SINGLE ROW LAYOUT -->

                  <!-- NEW MOBILE FLIGHT CARD DESIGN -->
                  <ng-container *ngIf="flight.Segments.length > 1; else singleSegmentBlock">
                    <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                      (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                      <ng-container *ngFor="let group of flight.Segments; let groupIndex = index">
                        <ng-container *ngFor="let segment of group; let i = index">
                          <!-- Flight Segment -->
                          <div class="flight-card-component__flight-leg">
                            <div class="flight-card-component__leg-header">
                              <img class="flight-card-component__airline-logo"
                                [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                [alt]="segment.Airline.AirlineName + ' logo'"
                                onerror="this.src='assets/images/default-airline.png'" />
                              <div class="flight-card-component__airline-name">
                                {{ segment.Airline.AirlineName }}
                              </div>
                              <div class="flight-card-component__flight-code">
                                {{ segment.Airline.AirlineCode }}
                                {{ segment.Airline.FlightNumber }}
                              </div>
                              <div class="flight-card-component__pill">
                                {{ segment.Craft || 'Aircraft' }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-row">
                              <div class="flight-card-component__flight-left">
                                <div class="flight-card-component__time">
                                  {{ segment.Origin.DepTime | date : "HH:mm" }}
                                </div>
                                <div class="flight-card-component__date">
                                  {{ segment.Origin.DepTime | date : "EEE, dd MMM" }}
                                </div>
                                <div class="flight-card-component__location">
                                  {{ segment.Origin.Airport.CityName }}
                                  <div class="flight-card-component_country-name">
                                    {{ segment.Origin.Airport.CountryName }}
                                  </div>
                                </div>
                              </div>

                              <div class="flight-card-component__flight-icon">
                                <i class="fas fa-plane"></i>
                                <div class="flight-card-component__duration">
                                  {{ formatMinutesToHrMin(segment.Duration) }}
                                </div>
                              </div>

                              <div class="flight-card-component__flight-right">
                                <div class="flight-card-component__day-diff"
                                  *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                  +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }}
                                  day
                                </div>
                                <div class="flight-card-component__time">
                                  {{ segment.Destination.ArrTime | date : "HH:mm" }}
                                </div>
                                <div class="flight-card-component__date">
                                  {{ segment.Destination.ArrTime | date : "EEE, dd MMM" }}
                                </div>
                                <div class="flight-card-component__location">
                                  {{ segment.Destination.Airport.CityName }}
                                  <div class="flight-card-component_country-name">
                                    {{ segment.Destination.Airport.CountryName }}
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <!-- Layover Section -->
                          <div *ngIf="i < group.length - 1" class="flight-card-component__layover-row">
                            <div class="flight-card-component__dotted-line"></div>
                            <div class="flight-card-component__layover">
                              <div class="flight-card-component__layover-day">
                                {{ getLayoverDayText(group[i], group[i + 1]) }}
                              </div>
                              <div class="flight-card-component__layover-time">
                                {{ getLayoverDuration(group[i], group[i + 1]) }}
                              </div>
                            </div>
                            <div class="flight-card-component__dotted-line"></div>
                          </div>
                        </ng-container>

                        <div class="flight-card-component__badges__intreturn" *ngIf="group?.length">
                          <span class="flight-card-component__pill">
                            {{ group.length - 1 === 0 ? "Non Stop" : group.length - 1 + " Stop" }}
                          </span>
                          <span class="flight-card-component__pill">
                            {{ getGroupDuration(group) }}
                          </span>
                        </div>

                        <!-- Separator Between Segment Groups -->
                        <div *ngIf="groupIndex < flight.Segments.length - 1"
                          class="flight-card-component__group-separator">
                          <div class="flight-card-component__dotted-line"></div>
                        </div>
                      </ng-container>

                      <!-- Footer -->
                      <div class="flight-card-component__footer">
                        <div class="flight-card-component__badges">
                        </div>
                        <div class="flight-card-component__price">
                          <div class="flight-card-component__amount">
                            ₹ {{ flight.price | number : "1.0-0" }}
                          </div>
                          <div class="flight-card-component__per">per Adult</div>
                        </div>
                        <button class="flight-card-component__view-prices-btn desktop-only"
                          (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                          View Prices
                        </button>
                      </div>
                    </section>
                  </ng-container>

                  <!-- Single Segment Block -->
                  <ng-template #singleSegmentBlock>
                    <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                      (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                      <ng-container *ngFor="let segment of flight.Segments[0]; let i = index">
                        <div class="flight-card-component__flight-leg">
                          <div class="flight-card-component__leg-header">
                            <img class="flight-card-component__airline-logo"
                              [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                              [alt]="segment.Airline.AirlineName + ' logo'"
                              onerror="this.src='assets/images/default-airline.png'" />
                            <div class="flight-card-component__airline-name">
                              {{ segment.Airline.AirlineName }}
                            </div>
                            <div class="flight-card-component__flight-code">
                              {{ segment.Airline.AirlineCode }} {{ segment.Airline.FlightNumber }}
                            </div>
                            <div class="flight-card-component__pill">
                              {{ segment.Craft || 'Aircraft' }}
                            </div>
                          </div>

                          <div class="flight-card-component__flight-row">
                            <div class="flight-card-component__flight-left">
                              <div class="flight-card-component__time">
                                {{ segment.Origin.DepTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Origin.DepTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Origin.Airport.CityName }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-icon">
                              <i class="fas fa-plane"></i>
                              <div class="flight-card-component__duration">
                                {{ formatMinutesToHrMin(segment.Duration) }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-right">
                              <div class="flight-card-component__day-diff"
                                *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }}
                                day
                              </div>
                              <div class="flight-card-component__time">
                                {{ segment.Destination.ArrTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Destination.ArrTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Destination.Airport.CityName }}
                              </div>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="i < flight.Segments[0].length - 1" class="flight-card-component__layover-row">
                          <div class="flight-card-component__dotted-line"></div>
                          <div class="flight-card-component__layover">
                            <div class="flight-card-component__layover-day">
                              {{ getLayoverDayText(flight.Segments[0][i], flight.Segments[0][i + 1]) }}
                            </div>
                            <div class="flight-card-component__layover-time">
                              {{ getLayoverDuration(flight.Segments[0][i], flight.Segments[0][i + 1]) }}
                            </div>
                          </div>
                          <div class="flight-card-component__dotted-line"></div>
                        </div>
                      </ng-container>

                      <div class="flight-card-component__footer">
                        <div class="flight-card-component__badges">
                          <span class="flight-card-component__pill">
                            {{ flight.Segments[0].length - 1 === 0 ? "Non Stop" : flight.Segments[0].length - 1 + " Stop"
                            }}
                          </span>
                          <span class="flight-card-component__pill">
                            {{ getTotalDuration(flight.Segments[0]) }}
                          </span>
                        </div>
                        <div class="flight-card-component__price">
                          <div class="flight-card-component__amount">
                            ₹ {{ flight.price | number : "1.0-0" }}
                          </div>
                          <div class="flight-card-component__per">per Adult</div>
                        </div>
                        <button class="flight-card-component__view-prices-btn desktop-only"
                          (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                          View Prices
                        </button>
                      </div>
                    </section>
                  </ng-template>
                  <!-- END NEW MOBILE FLIGHT CARD DESIGN -->

                  <!-- Date Hanger -->
                  <div class="date-hanger">
                    <div class="date-content">
                      <span class="date-text">{{ flightInputData['departureDate'] | date : "d MMM, yyyy" }}</span>
                    </div>
                  </div>

                  <!-- Route -->
                  <div class="route">
                    <div class="vehicle">
                      <img [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                        [alt]="flight.Segments[0][0].Airline.AirlineName"
                        onerror="this.src='assets/images/default-airline.png'" />
                    </div>

                    <div class="route-column">
                      <div class="route-code">{{ flight.Segments[0][0].Origin.Airport.AirportCode }}</div>
                      <div class="location">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                    </div>

                    <div class="route-visualization">
                      <div></div>
                      <div class="route-line">
                        <div class="route-node start-node"></div>
                        <div class="route-car">
                          <i class="fas fa-plane" style="font-size: 24px; color: #008b8b;"></i>
                        </div>
                        <div class="route-node end-node"></div>
                      </div>
                      <div class="route-details">
                        <div class="time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }} - {{
                          flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm" }}
                        </div>
                        <div class="duration">{{ getTotalDuration(flight.Segments[0]) }}</div>
                      </div>
                    </div>

                    <div class="route-column">
                      <div class="route-code">{{ flight.Segments[0][flight.Segments[0].length -
                        1].Destination.Airport.AirportCode }}</div>
                      <div class="location">{{ flight.Segments[0][flight.Segments[0].length -
                        1].Destination.Airport.CityName }}</div>
                    </div>
                  </div>

                  <!-- Mobile Amenities + Airline Display -->
                  <div class="mobile-amenities">
                    <div class="amenities-list">
                      <div class="amenity">
                        <i class="fas fa-plane-departure"></i>
                        <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                          (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                      </div>
                      <div class="amenity">
                        <i class="fas fa-suitcase"></i>
                        <span>Baggage</span>
                      </div>
                      <div class="amenity">
                        <i class="fas fa-ban"></i>
                        <span>Policy</span>
                      </div>
                    </div>
                    <div class="mobile-vehicle-visual">
                      <img [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                        [alt]="flight.Segments[0][0].Airline.AirlineName"
                        onerror="this.src='assets/images/default-airline.png'" />
                      <div class="mobile-vehicle-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                    </div>
                  </div>

                  <!-- Mobile Price Row -->
                  <div class="mobile-price-row">
                    <div class="mobile-seats-left">
                      <i class="fas fa-users"></i>
                      <span>Available</span>
                    </div>
                    <div class="mobile-start-price">
                      <span>Starts </span>
                      <span class="mobile-price">₹ {{ flight.price | number : "1.0-0" }}</span>
                    </div>
                  </div>

                  <!-- Mobile Booking Button -->
                  <div class="mobile-booking-row">
                    <button class="btn mobile-book-btn"
                      (click)="openFareOptionsModal(flight); $event.stopPropagation()">
                      View Prices
                    </button>
                  </div>

                  <!-- Options -->
                  <div class="options">
                    <!-- Column 1: Stops/Amenities -->
                    <div class="option-item">
                      <div class="default-amenities">
                        <div class="amenity-item">
                          <i class="fas fa-plane-departure"></i>
                          <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                            (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                        </div>
                      </div>
                      <div class="hover-dropdowns">
                        <div class="dropdown">
                          <i class="fas fa-list-alt"></i>
                          <span>Flight Details</span>
                          <div class="dropdown-content">
                            {{ getStopsSummary(flight) }} - Duration: {{ getTotalDuration(flight.Segments[0]) }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Column 2: Baggage/Instructions -->
                    <div class="option-item">
                      <div class="default-amenities">
                        <div class="amenity-item">
                          <i class="fas fa-suitcase"></i>
                          <span>Baggage</span>
                        </div>
                      </div>
                      <div class="hover-dropdowns">
                        <div class="dropdown">
                          <i class="fas fa-info-circle"></i>
                          <span>Details</span>
                          <div class="dropdown-content">
                            Check-in: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.Baggage || '15kg' }}<br>
                            Cabin: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.CabinBaggage || '7kg' }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Column 3: Policy/Cancellation Policy -->
                    <div class="option-item">
                      <div class="default-amenities">
                        <div class="amenity-item">
                          <i class="fas fa-ban"></i>
                          <span>Policy</span>
                        </div>
                      </div>
                      <div class="hover-dropdowns">
                        <div class="dropdown">
                          <i class="fas fa-ban"></i>
                          <span>Cancellation</span>
                          <div class="dropdown-content">
                            {{ getCancellationRule(selectedFareOptions[i] || flight.FareOptions[0]) }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Column 4: Price & View Prices Button -->
                    <div class="select-btn-card">
                      <div class="desktop-price-display">
                        <span class="price-label">Starts from</span>
                        <span class="price-value">₹ {{ flight.price | number : "1.0-0" }}</span>
                      </div>
                      <button class="btn" (click)="openFareOptionsModal(flight); $event.stopPropagation()">View
                        Prices</button>
                    </div>
                  </div>

                  <!-- Expandable Details -->
                  <div class="flight-details-expanded" *ngIf="flightDetailsExpanded[i]"
                    (click)="$event.stopPropagation()">
                    <div class="flight-tabs">
                      <div class="tab" *ngFor="let tab of tabs" [class.active]="activeTabs[i] === tab.id"
                        (click)="selectTab(i, tab.id); $event.stopPropagation()">
                        {{ tab.label }}
                      </div>
                    </div>

                    <!-- Flight Details Tab -->
                    <div class="tab-content" *ngIf="activeTabs[i] === 'flight'">
                      <div class="segment-details" *ngFor="let segment of flight.Segments[0]">
                        <div class="flight-segment-layout">
                          <div class="flight-info-compact">
                            <img [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                              [alt]="segment.Airline.AirlineName" width="60" height="60"
                              onerror="this.src='assets/images/default-airline.png'" />
                            <div class="flight-name-number">
                              <strong>{{ segment.Airline.AirlineName }}</strong> {{ segment.Airline.FlightNumber }}
                            </div>
                          </div>
                          <div class="timing-info">
                            <div class="time-block">
                              <div class="time">{{ segment.Origin.DepTime | date : "HH:mm" }}</div>
                              <div class="airport">{{ segment.Origin.Airport.CityName }} ({{
                                segment.Origin.Airport.AirportCode }})</div>
                            </div>
                            <div class="duration">{{ getFormattedDuration(segment.Duration) }}</div>
                            <div class="time-block">
                              <div class="time">{{ segment.Destination.ArrTime | date : "HH:mm" }}</div>
                              <div class="airport">{{ segment.Destination.Airport.CityName }} ({{
                                segment.Destination.Airport.AirportCode }})</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Fare Summary Tab -->
                    <div class="tab-content" *ngIf="activeTabs[i] === 'fare'">
                      <table class="fare-table">
                        <tr>
                          <th>Total</th>
                          <td><strong>₹ {{ selectedFareOptions[i]?.Fare?.PublishedFare | number : "1.0-0" }}</strong>
                          </td>
                        </tr>
                        <tr>
                          <th>Base Fare</th>
                          <td>₹ {{ selectedFareOptions[i]?.Fare?.BaseFare | number : "1.0-0" }}</td>
                        </tr>
                        <tr>
                          <th>Taxes & Fees</th>
                          <td>₹ {{ selectedFareOptions[i]?.Fare?.Tax | number : "1.0-0" }}</td>
                        </tr>
                      </table>
                    </div>

                    <!-- Cancellation Tab -->
                    <div class="tab-content" *ngIf="activeTabs[i] === 'cancellation'">
                      <div class="policy-content">
                        <p>{{ getCancellationRule(selectedFareOptions[i] || flight.FareOptions[0]) }}</p>
                      </div>
                    </div>

                    <!-- Date Change Tab -->
                    <div class="tab-content" *ngIf="activeTabs[i] === 'dateChange'">
                      <div class="policy-content">
                        <p>{{ getDateChangeRule(selectedFareOptions[i] || flight.FareOptions[0]) }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- No Flights Message -->
              <div class="no-flights" *ngIf="(!groupedFlights || groupedFlights.length === 0) && !loader">
                <p>No flights found for your search criteria. Please try modifying your search.</p>
              </div>
            </div>

            <!-- Round Trip Flights -->
            <div *ngIf="flightType === 'round'" class="roundtrip-results-page">
              <!-- Tab Bar -->
              <div class="roundtrip-tab-bar" #tabBar>
                <div class="tab-item" [class.active]="activeTab === 'onward'" (click)="switchTab('onward')" #onwardTab>
                  <div class="tab-sector">
                    {{ flightInputData['fromAirportCode'] || flightInputData['fromCity'] }}
                    <i class="fas fa-plane-departure"></i>
                    {{ flightInputData['toAirportCode'] || flightInputData['toCity'] }}
                  </div>
                  <div class="tab-date">
                    Onward : {{ flightInputData['departureDate'] | date : "EEE, dd MMM" }}
                  </div>
                </div>
                <div class="tab-item" [class.active]="activeTab === 'return'" (click)="switchTab('return')" #returnTab>
                  <div class="tab-sector">
                    {{ flightInputData['toAirportCode'] || flightInputData['toCity'] }}
                    <i class="fas fa-plane-arrival"></i>
                    {{ flightInputData['fromAirportCode'] || flightInputData['fromCity'] }}
                  </div>
                  <div class="tab-date">
                    Return : {{ flightInputData['returnDate'] | date : "EEE, dd MMM" }}
                  </div>
                </div>
                <div class="tab-underline" [ngStyle]="underlineStyle"></div>
              </div>

              <!-- Scrollable Tab Content -->
              <div class="tab-scroll-container" #scrollContainer>
                <div class="tab-pane">
                  <!-- Onward Tab Content -->
                  <div class="tab-content" *ngIf="activeTab === 'onward'">
                    <div class="flight-cards">
                      <div class="card mobile-flight-card-new" [class.roundtrip-selected]="selectedOutboundIndex === i"
                        *ngFor="let flight of groupedFlights; let i = index">
                        <label class="flight-radio-wrapper"
                          (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">
                          <input type="radio" name="outboundFlight" [value]="flight" [(ngModel)]="selectedOutbound" />

                          <!-- DESKTOP SINGLE ROW LAYOUT -->
                          <div class="desktop-flight-row">
                            <!-- Airline Section -->
                            <div class="desktop-airline-section">
                              <img class="desktop-airline-logo"
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                              <div class="desktop-airline-info">
                                <div class="desktop-airline-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                                <div class="desktop-flight-number">{{ flight.Segments[0][0].Airline.AirlineCode }} {{ flight.Segments[0][0].Airline.FlightNumber }}</div>
                                <div class="desktop-aircraft-type">{{ flight.Segments[0][0].Craft || 'Aircraft' }}</div>
                              </div>
                            </div>

                            <!-- Departure Section -->
                            <div class="desktop-departure-section">
                              <div class="desktop-time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }}</div>
                              <div class="desktop-date">{{ flight.Segments[0][0].Origin.DepTime | date : "EEE, dd MMM" }}</div>
                              <div class="desktop-airport">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                            </div>

                            <!-- Duration & Stops Section -->
                            <div class="desktop-duration-section">
                              <div class="desktop-duration-text">{{ getTotalDuration(flight.Segments[0]) }}</div>
                              <div class="desktop-stops-text">{{ getStopsCount(flight) === 0 ? 'Non Stop' : getStopsCount(flight) + ' Stop' + (getStopsCount(flight) > 1 ? 's' : '') }}</div>
                            </div>

                            <!-- Arrival Section -->
                            <div class="desktop-arrival-section">
                              <div class="desktop-time">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm" }}</div>
                              <div class="desktop-date">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "EEE, dd MMM" }}</div>
                              <div class="desktop-airport">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.Airport.CityName }}</div>
                              <div class="desktop-day-diff" *ngIf="getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) > 0">
                                +{{ getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) }} day
                              </div>
                            </div>

                            <!-- Price & Button Section -->
                            <div class="desktop-price-section">
                              <div class="desktop-price-amount">₹ {{ flight.price | number : "1.0-0" }}</div>
                              <div class="desktop-price-label">per Adult</div>
                              <button class="desktop-view-prices-btn" (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">
                                View Prices
                              </button>
                            </div>
                          </div>
                          <!-- END DESKTOP SINGLE ROW LAYOUT -->

                          <!-- NEW MOBILE FLIGHT CARD DESIGN -->
                          <ng-container *ngIf="flight.Segments.length > 1; else singleSegmentBlockOnward">
                            <section class="flight-card-component__flight-card" aria-label="Flight Option">
                              <ng-container *ngFor="let group of flight.Segments; let groupIndex = index">
                                <ng-container *ngFor="let segment of group; let j = index">
                                  <div class="flight-card-component__flight-leg">
                                    <div class="flight-card-component__leg-header">
                                      <img class="flight-card-component__airline-logo"
                                        [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                        [alt]="segment.Airline.AirlineName + ' logo'"
                                        onerror="this.src='assets/images/default-airline.png'" />
                                      <div class="flight-card-component__airline-name">{{ segment.Airline.AirlineName }}
                                      </div>
                                      <div class="flight-card-component__flight-code">{{ segment.Airline.AirlineCode }}
                                        {{ segment.Airline.FlightNumber }}</div>
                                      <div class="flight-card-component__pill">{{ segment.Craft || 'Aircraft' }}</div>
                                    </div>
                                    <div class="flight-card-component__flight-row">
                                      <div class="flight-card-component__flight-left">
                                        <div class="flight-card-component__time">{{ segment.Origin.DepTime | date :
                                          "HH:mm" }}</div>
                                        <div class="flight-card-component__date">{{ segment.Origin.DepTime | date :
                                          "EEE, dd MMM" }}</div>
                                        <div class="flight-card-component__location">{{ segment.Origin.Airport.CityName
                                          }}<div class="flight-card-component_country-name">{{
                                            segment.Origin.Airport.CountryName }}</div>
                                        </div>
                                      </div>
                                      <div class="flight-card-component__flight-icon">
                                        <i class="fas fa-plane"></i>
                                        <div class="flight-card-component__duration">{{
                                          formatMinutesToHrMin(segment.Duration) }}</div>
                                      </div>
                                      <div class="flight-card-component__flight-right">
                                        <div class="flight-card-component__day-diff"
                                          *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                          +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }} day
                                        </div>
                                        <div class="flight-card-component__time">{{ segment.Destination.ArrTime | date :
                                          "HH:mm" }}</div>
                                        <div class="flight-card-component__date">{{ segment.Destination.ArrTime | date :
                                          "EEE, dd MMM" }}</div>
                                        <div class="flight-card-component__location">{{
                                          segment.Destination.Airport.CityName }}<div
                                            class="flight-card-component_country-name">{{
                                            segment.Destination.Airport.CountryName }}</div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                  <div *ngIf="j < group.length - 1" class="flight-card-component__layover-row">
                                    <div class="flight-card-component__dotted-line"></div>
                                    <div class="flight-card-component__layover">
                                      <div class="flight-card-component__layover-day">{{ getLayoverDayText(group[j],
                                        group[j + 1]) }}</div>
                                      <div class="flight-card-component__layover-time">{{ getLayoverDuration(group[j],
                                        group[j + 1]) }}</div>
                                    </div>
                                    <div class="flight-card-component__dotted-line"></div>
                                  </div>
                                </ng-container>
                                <div class="flight-card-component__badges__intreturn" *ngIf="group?.length">
                                  <span class="flight-card-component__pill">{{ group.length - 1 === 0 ? "Non Stop" :
                                    group.length - 1 + " Stop" }}</span>
                                  <span class="flight-card-component__pill">{{ getGroupDuration(group) }}</span>
                                </div>
                                <div *ngIf="groupIndex < flight.Segments.length - 1"
                                  class="flight-card-component__group-separator">
                                  <div class="flight-card-component__dotted-line"></div>
                                </div>
                              </ng-container>
                              <div class="flight-card-component__footer">
                                <div class="flight-card-component__badges">
                                </div>
                                <div class="flight-card-component__price">
                                  <div class="flight-card-component__amount">₹ {{ flight.price | number : "1.0-0" }}
                                  </div>
                                  <div class="flight-card-component__per">per Adult</div>
                                </div>
                                <button class="flight-card-component__view-prices-btn desktop-only"
                                  (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">
                                  View Prices
                                </button>
                              </div>
                            </section>
                          </ng-container>
                          <ng-template #singleSegmentBlockOnward>
                            <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                              (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">
                              <ng-container *ngFor="let segment of flight.Segments[0]; let j = index">
                                <div class="flight-card-component__flight-leg">
                                  <div class="flight-card-component__leg-header">
                                    <img class="flight-card-component__airline-logo"
                                      [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                      [alt]="segment.Airline.AirlineName + ' logo'"
                                      onerror="this.src='assets/images/default-airline.png'" />
                                    <div class="flight-card-component__airline-name">{{ segment.Airline.AirlineName }}
                                    </div>
                                    <div class="flight-card-component__flight-code">{{ segment.Airline.AirlineCode }} {{
                                      segment.Airline.FlightNumber }}</div>
                                    <div class="flight-card-component__pill">{{ segment.Craft || 'Aircraft' }}</div>
                                  </div>
                                  <div class="flight-card-component__flight-row">
                                    <div class="flight-card-component__flight-left">
                                      <div class="flight-card-component__time">{{ segment.Origin.DepTime | date :
                                        "HH:mm" }}</div>
                                      <div class="flight-card-component__date">{{ segment.Origin.DepTime | date : "EEE,
                                        dd MMM" }}</div>
                                      <div class="flight-card-component__location">{{ segment.Origin.Airport.CityName }}
                                      </div>
                                    </div>
                                    <div class="flight-card-component__flight-icon">
                                      <i class="fas fa-plane"></i>
                                      <div class="flight-card-component__duration">{{
                                        formatMinutesToHrMin(segment.Duration) }}</div>
                                    </div>
                                    <div class="flight-card-component__flight-right">
                                      <div class="flight-card-component__day-diff"
                                        *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">+{{
                                        getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }} day</div>
                                      <div class="flight-card-component__time">{{ segment.Destination.ArrTime | date :
                                        "HH:mm" }}</div>
                                      <div class="flight-card-component__date">{{ segment.Destination.ArrTime | date :
                                        "EEE, dd MMM" }}</div>
                                      <div class="flight-card-component__location">{{
                                        segment.Destination.Airport.CityName }}</div>
                                    </div>
                                  </div>
                                </div>
                                <div *ngIf="j < flight.Segments[0].length - 1"
                                  class="flight-card-component__layover-row">
                                  <div class="flight-card-component__dotted-line"></div>
                                  <div class="flight-card-component__layover">
                                    <div class="flight-card-component__layover-day">{{
                                      getLayoverDayText(flight.Segments[0][j], flight.Segments[0][j + 1]) }}</div>
                                    <div class="flight-card-component__layover-time">{{
                                      getLayoverDuration(flight.Segments[0][j], flight.Segments[0][j + 1]) }}</div>
                                  </div>
                                  <div class="flight-card-component__dotted-line"></div>
                                </div>
                              </ng-container>
                              <div class="flight-card-component__footer">
                                <div class="flight-card-component__badges">
                                  <span class="flight-card-component__pill">{{ flight.Segments[0].length - 1 === 0 ? "Non
                                    Stop" : flight.Segments[0].length - 1 + " Stop" }}</span>
                                  <span class="flight-card-component__pill">{{ getTotalDuration(flight.Segments[0])
                                    }}</span>
                                </div>
                                <div class="flight-card-component__price">
                                  <div class="flight-card-component__amount">₹ {{ flight.price | number : "1.0-0" }}
                                  </div>
                                  <div class="flight-card-component__per">per Adult</div>
                                </div>
                                <button class="flight-card-component__view-prices-btn desktop-only"
                                  (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">
                                  View Prices
                                </button>
                              </div>
                            </section>
                          </ng-template>
                          <!-- END NEW MOBILE FLIGHT CARD DESIGN -->

                          <div class="refundability-tag"
                            [ngClass]="{ 'refundable': flight.isRefundable, 'non-refundable': !flight.isRefundable }">
                            {{ flight.isRefundable ? "Partially Refundable" : "Non-refundable" }}
                          </div>
                          <!-- Date Hanger -->
                          <div class="date-hanger">
                            <div class="date-content">
                              <span class="date-text">{{ flightInputData['departureDate'] | date : "d MMM, yyyy"
                                }}</span>
                            </div>
                          </div>

                          <!-- Route -->
                          <div class="route">
                            <div class="vehicle">
                              <img
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                            </div>

                            <div class="route-column">
                              <div class="route-code">{{ flight.Segments[0][0].Origin.Airport.AirportCode }}</div>
                              <div class="location">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                            </div>

                            <div class="route-visualization">
                              <div></div>
                              <div class="route-line">
                                <div class="route-node start-node"></div>
                                <div class="route-car">
                                  <i class="fas fa-plane" style="font-size: 24px; color: #008b8b;"></i>
                                </div>
                                <div class="route-node end-node"></div>
                              </div>
                              <div class="route-details">
                                <div class="time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }} - {{
                                  flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm"
                                  }}</div>
                                <div class="duration">{{ getTotalDuration(flight.Segments[0]) }}</div>
                              </div>
                            </div>

                            <div class="route-column">
                              <div class="route-code">{{ flight.Segments[0][flight.Segments[0].length -
                                1].Destination.Airport.AirportCode }}</div>
                              <div class="location">{{ flight.Segments[0][flight.Segments[0].length -
                                1].Destination.Airport.CityName }}</div>
                            </div>
                          </div>

                          <!-- Mobile Amenities + Airline Display -->
                          <div class="mobile-amenities">
                            <div class="amenities-list">
                              <div class="amenity">
                                <i class="fas fa-plane-departure"></i>
                                <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                                  (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                              </div>
                              <div class="amenity">
                                <i class="fas fa-suitcase"></i>
                                <span>Baggage</span>
                              </div>
                              <div class="amenity">
                                <i class="fas fa-ban"></i>
                                <span>Policy</span>
                              </div>
                            </div>
                            <div class="mobile-vehicle-visual">
                              <img
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                              <div class="mobile-vehicle-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                            </div>
                          </div>

                          <!-- Mobile Price Row -->
                          <div class="mobile-price-row">
                            <div class="mobile-seats-left">
                              <i class="fas fa-users"></i>
                              <span>Available</span>
                            </div>
                            <div class="mobile-start-price">
                              <span>Starts </span>
                              <span class="mobile-price">₹ {{ flight.price | number : "1.0-0" }}</span>
                            </div>
                          </div>

                          <!-- Mobile Booking Button -->
                          <div class="mobile-booking-row">
                            <button class="btn mobile-book-btn"
                              (click)="openFareOptionsModalForRoundTrip(flight, i, activeTab); $event.stopPropagation()">
                              View Prices
                            </button>
                          </div>

                          <!-- Options -->
                          <div class="options">
                            <!-- Column 1: Stops/Amenities -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-plane-departure"></i>
                                  <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                                    (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-list-alt"></i>
                                  <span>Flight Details</span>
                                  <div class="dropdown-content">
                                    {{ getStopsSummary(flight) }} - Duration: {{ getTotalDuration(flight.Segments[0]) }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 2: Baggage/Instructions -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-suitcase"></i>
                                  <span>Baggage</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-info-circle"></i>
                                  <span>Details</span>
                                  <div class="dropdown-content">
                                    Check-in: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.Baggage || '15kg' }}<br>
                                    Cabin: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.CabinBaggage || '7kg' }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 3: Policy/Cancellation Policy -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-ban"></i>
                                  <span>Policy</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-ban"></i>
                                  <span>Cancellation</span>
                                  <div class="dropdown-content">
                                    {{ getCancellationRule(selectedFareOptions[i] || flight.FareOptions[0]) }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 4: Price & View Prices Button -->
                            <div class="select-btn-card">
                              <div class="desktop-price-display">
                                <span class="price-label">Starts from</span>
                                <span class="price-value">₹ {{ flight.price | number : "1.0-0" }}</span>
                              </div>
                              <button class="btn"
                                (click)="openFareOptionsModalForRoundTrip(flight, i, 'onward'); $event.stopPropagation()">View
                                Prices</button>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="tab-pane">
                  <!-- Return Tab Content -->
                  <div class="tab-content return-tab-content" *ngIf="activeTab === 'return'">
                    <div class="flight-cards">
                      <div class="card mobile-flight-card-new" [class.roundtrip-selected]="selectedReturnIndex === i"
                        *ngFor="let flight of groupedFlightsOutbound; let i = index">
                        <label class="flight-radio-wrapper"
                          (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                          <input type="radio" name="returnFlight" [value]="flight" [(ngModel)]="selectedReturn" />

                          <!-- DESKTOP SINGLE ROW LAYOUT -->
                          <div class="desktop-flight-row">
                            <!-- Airline Section -->
                            <div class="desktop-airline-section">
                              <img class="desktop-airline-logo"
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                              <div class="desktop-airline-info">
                                <div class="desktop-airline-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                                <div class="desktop-flight-number">{{ flight.Segments[0][0].Airline.AirlineCode }} {{ flight.Segments[0][0].Airline.FlightNumber }}</div>
                                <div class="desktop-aircraft-type">{{ flight.Segments[0][0].Craft || 'Aircraft' }}</div>
                              </div>
                            </div>

                            <!-- Departure Section -->
                            <div class="desktop-departure-section">
                              <div class="desktop-time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }}</div>
                              <div class="desktop-date">{{ flight.Segments[0][0].Origin.DepTime | date : "EEE, dd MMM" }}</div>
                              <div class="desktop-airport">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                            </div>

                            <!-- Duration & Stops Section -->
                            <div class="desktop-duration-section">
                              <div class="desktop-duration-text">{{ getTotalDuration(flight.Segments[0]) }}</div>
                              <div class="desktop-stops-text">{{ getStopsCount(flight) === 0 ? 'Non Stop' : getStopsCount(flight) + ' Stop' + (getStopsCount(flight) > 1 ? 's' : '') }}</div>
                            </div>

                            <!-- Arrival Section -->
                            <div class="desktop-arrival-section">
                              <div class="desktop-time">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm" }}</div>
                              <div class="desktop-date">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "EEE, dd MMM" }}</div>
                              <div class="desktop-airport">{{ flight.Segments[0][flight.Segments[0].length - 1].Destination.Airport.CityName }}</div>
                              <div class="desktop-day-diff" *ngIf="getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) > 0">
                                +{{ getDayDiff(flight.Segments[0][0].Origin.DepTime, flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime) }} day
                              </div>
                            </div>

                            <!-- Price & Button Section -->
                            <div class="desktop-price-section">
                              <div class="desktop-price-amount">₹ {{ flight.price | number : "1.0-0" }}</div>
                              <div class="desktop-price-label">per Adult</div>
                              <button class="desktop-view-prices-btn" (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                                View Prices
                              </button>
                            </div>
                          </div>
                          <!-- END DESKTOP SINGLE ROW LAYOUT -->

                          <!-- NEW MOBILE FLIGHT CARD DESIGN -->
                          <ng-container *ngIf="flight.Segments.length > 1; else singleSegmentBlockReturn">
                            <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                              (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                              <ng-container *ngFor="let group of flight.Segments; let groupIndex = index">
                                <ng-container *ngFor="let segment of group; let j = index">
                                  <div class="flight-card-component__flight-leg">
                                    <div class="flight-card-component__leg-header">
                                      <img class="flight-card-component__airline-logo"
                                        [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                        [alt]="segment.Airline.AirlineName + ' logo'"
                                        onerror="this.src='assets/images/default-airline.png'" />
                                      <div class="flight-card-component__airline-name">{{ segment.Airline.AirlineName }}
                                      </div>
                                      <div class="flight-card-component__flight-code">{{ segment.Airline.AirlineCode }}
                                        {{ segment.Airline.FlightNumber }}</div>
                                      <div class="flight-card-component__pill">{{ segment.Craft || 'Aircraft' }}</div>
                                    </div>
                                    <div class="flight-card-component__flight-row">
                                      <div class="flight-card-component__flight-left">
                                        <div class="flight-card-component__time">{{ segment.Origin.DepTime | date :
                                          "HH:mm" }}</div>
                                        <div class="flight-card-component__date">{{ segment.Origin.DepTime | date :
                                          "EEE, dd MMM" }}</div>
                                        <div class="flight-card-component__location">{{ segment.Origin.Airport.CityName
                                          }}<div class="flight-card-component_country-name">{{
                                            segment.Origin.Airport.CountryName }}</div>
                                        </div>
                                      </div>
                                      <div class="flight-card-component__flight-icon">
                                        <i class="fas fa-plane"></i>
                                        <div class="flight-card-component__duration">{{
                                          formatMinutesToHrMin(segment.Duration) }}</div>
                                      </div>
                                      <div class="flight-card-component__flight-right">
                                        <div class="flight-card-component__day-diff"
                                          *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                          +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }} day
                                        </div>
                                        <div class="flight-card-component__time">{{ segment.Destination.ArrTime | date :
                                          "HH:mm" }}</div>
                                        <div class="flight-card-component__date">{{ segment.Destination.ArrTime | date :
                                          "EEE, dd MMM" }}</div>
                                        <div class="flight-card-component__location">{{
                                          segment.Destination.Airport.CityName }}<div
                                            class="flight-card-component_country-name">{{
                                            segment.Destination.Airport.CountryName }}</div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                  <div *ngIf="j < group.length - 1" class="flight-card-component__layover-row">
                                    <div class="flight-card-component__dotted-line"></div>
                                    <div class="flight-card-component__layover">
                                      <div class="flight-card-component__layover-day">{{ getLayoverDayText(group[j],
                                        group[j + 1]) }}</div>
                                      <div class="flight-card-component__layover-time">{{ getLayoverDuration(group[j],
                                        group[j + 1]) }}</div>
                                    </div>
                                    <div class="flight-card-component__dotted-line"></div>
                                  </div>
                                </ng-container>
                                <div class="flight-card-component__badges__intreturn " *ngIf="group?.length">
                                  <span class="flight-card-component__pill">{{ group.length - 1 === 0 ? "Non Stop" :
                                    group.length - 1 + " Stop" }}</span>
                                  <span class="flight-card-component__pill">{{ getGroupDuration(group) }}</span>
                                </div>
                                <div *ngIf="groupIndex < flight.Segments.length - 1"
                                  class="flight-card-component__group-separator">
                                  <div class="flight-card-component__dotted-line"></div>
                                </div>
                              </ng-container>
                              <div class="flight-card-component__footer">
                                <div class="flight-card-component__badges">
                                </div>
                                <div class="flight-card-component__price">
                                  <div class="flight-card-component__amount">₹ {{ flight.price | number : "1.0-0" }}
                                  </div>
                                  <div class="flight-card-component__per">per Adult</div>
                                </div>
                                <button class="flight-card-component__view-prices-btn desktop-only"
                                  (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                                  View Prices
                                </button>
                              </div>
                            </section>
                          </ng-container>
                          <ng-template #singleSegmentBlockReturn>
                            <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                              (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                              <ng-container *ngFor="let segment of flight.Segments[0]; let j = index">
                                <div class="flight-card-component__flight-leg">
                                  <div class="flight-card-component__leg-header">
                                    <img class="flight-card-component__airline-logo"
                                      [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                      [alt]="segment.Airline.AirlineName + ' logo'"
                                      onerror="this.src='assets/images/default-airline.png'" />
                                    <div class="flight-card-component__airline-name">{{ segment.Airline.AirlineName }}
                                    </div>
                                    <div class="flight-card-component__flight-code">{{ segment.Airline.AirlineCode }} {{
                                      segment.Airline.FlightNumber }}</div>
                                    <div class="flight-card-component__pill">{{ segment.Craft || 'Aircraft' }}</div>
                                  </div>
                                  <div class="flight-card-component__flight-row">
                                    <div class="flight-card-component__flight-left">
                                      <div class="flight-card-component__time">{{ segment.Origin.DepTime | date :
                                        "HH:mm" }}</div>
                                      <div class="flight-card-component__date">{{ segment.Origin.DepTime | date : "EEE,
                                        dd MMM" }}</div>
                                      <div class="flight-card-component__location">{{ segment.Origin.Airport.CityName }}
                                      </div>
                                    </div>
                                    <div class="flight-card-component__flight-icon">
                                      <i class="fas fa-plane"></i>
                                      <div class="flight-card-component__duration">{{
                                        formatMinutesToHrMin(segment.Duration) }}</div>
                                    </div>
                                    <div class="flight-card-component__flight-right">
                                      <div class="flight-card-component__day-diff"
                                        *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">+{{
                                        getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }} day</div>
                                      <div class="flight-card-component__time">{{ segment.Destination.ArrTime | date :
                                        "HH:mm" }}</div>
                                      <div class="flight-card-component__date">{{ segment.Destination.ArrTime | date :
                                        "EEE, dd MMM" }}</div>
                                      <div class="flight-card-component__location">{{
                                        segment.Destination.Airport.CityName }}</div>
                                    </div>
                                  </div>
                                </div>
                                <div *ngIf="j < flight.Segments[0].length - 1"
                                  class="flight-card-component__layover-row">
                                  <div class="flight-card-component__dotted-line"></div>
                                  <div class="flight-card-component__layover">
                                    <div class="flight-card-component__layover-day">{{
                                      getLayoverDayText(flight.Segments[0][j], flight.Segments[0][j + 1]) }}</div>
                                    <div class="flight-card-component__layover-time">{{
                                      getLayoverDuration(flight.Segments[0][j], flight.Segments[0][j + 1]) }}</div>
                                  </div>
                                  <div class="flight-card-component__dotted-line"></div>
                                </div>
                              </ng-container>
                              <div class="flight-card-component__footer">
                                <div class="flight-card-component__badges">
                                  <span class="flight-card-component__pill">{{ flight.Segments[0].length - 1 === 0 ? "Non
                                    Stop" : flight.Segments[0].length - 1 + " Stop" }}</span>
                                  <span class="flight-card-component__pill">{{ getTotalDuration(flight.Segments[0])
                                    }}</span>
                                </div>
                                <div class="flight-card-component__price">
                                  <div class="flight-card-component__amount">₹ {{ flight.price | number : "1.0-0" }}
                                  </div>
                                  <div class="flight-card-component__per">per Adult</div>
                                </div>
                                <button class="flight-card-component__view-prices-btn desktop-only"
                                  (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">
                                  View Prices
                                </button>
                              </div>
                            </section>
                          </ng-template>
                          <!-- END NEW MOBILE FLIGHT CARD DESIGN -->

                          <div class="refundability-tag"
                            [ngClass]="{ 'refundable': flight.isRefundable, 'non-refundable': !flight.isRefundable }">
                            {{ flight.isRefundable ? "Partially Refundable" : "Non-refundable" }}
                          </div>
                          <!-- Date Hanger -->
                          <div class="date-hanger">
                            <div class="date-content">
                              <span class="date-text">{{ flightInputData['returnDate'] | date : "d MMM, yyyy" }}</span>
                            </div>
                          </div>

                          <!-- Route -->
                          <div class="route">
                            <div class="vehicle">
                              <img
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                            </div>

                            <div class="route-column">
                              <div class="route-code">{{ flight.Segments[0][0].Origin.Airport.AirportCode }}</div>
                              <div class="location">{{ flight.Segments[0][0].Origin.Airport.CityName }}</div>
                            </div>

                            <div class="route-visualization">
                              <div></div>
                              <div class="route-line">
                                <div class="route-node start-node"></div>
                                <div class="route-car">
                                  <i class="fas fa-plane" style="font-size: 24px; color: #008b8b;"></i>
                                </div>
                                <div class="route-node end-node"></div>
                              </div>
                              <div class="route-details">
                                <div class="time">{{ flight.Segments[0][0].Origin.DepTime | date : "HH:mm" }} - {{
                                  flight.Segments[0][flight.Segments[0].length - 1].Destination.ArrTime | date : "HH:mm"
                                  }}</div>
                                <div class="duration">{{ getTotalDuration(flight.Segments[0]) }}</div>
                              </div>
                            </div>

                            <div class="route-column">
                              <div class="route-code">{{ flight.Segments[0][flight.Segments[0].length -
                                1].Destination.Airport.AirportCode }}</div>
                              <div class="location">{{ flight.Segments[0][flight.Segments[0].length -
                                1].Destination.Airport.CityName }}</div>
                            </div>
                          </div>

                          <!-- Mobile Amenities + Airline Display -->
                          <div class="mobile-amenities">
                            <div class="amenities-list">
                              <div class="amenity">
                                <i class="fas fa-plane-departure"></i>
                                <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                                  (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                              </div>
                              <div class="amenity">
                                <i class="fas fa-suitcase"></i>
                                <span>Baggage</span>
                              </div>
                              <div class="amenity">
                                <i class="fas fa-ban"></i>
                                <span>Policy</span>
                              </div>
                            </div>
                            <div class="mobile-vehicle-visual">
                              <img
                                [src]="'assets/images/flightimages/' + flight.Segments[0][0].Airline.AirlineCode + '.png'"
                                [alt]="flight.Segments[0][0].Airline.AirlineName"
                                onerror="this.src='assets/images/default-airline.png'" />
                              <div class="mobile-vehicle-name">{{ flight.Segments[0][0].Airline.AirlineName }}</div>
                            </div>
                          </div>

                          <!-- Mobile Price Row -->
                          <div class="mobile-price-row">
                            <div class="mobile-seats-left">
                              <i class="fas fa-users"></i>
                              <span>Available</span>
                            </div>
                            <div class="mobile-start-price">
                              <span>Starts </span>
                              <span class="mobile-price">₹ {{ flight.price | number : "1.0-0" }}</span>
                            </div>
                          </div>

                          <!-- Mobile Booking Button -->
                          <div class="mobile-booking-row">
                            <button class="btn mobile-book-btn"
                              (click)="openFareOptionsModalForRoundTrip(flight, i, activeTab); $event.stopPropagation()">
                              View Prices
                            </button>
                          </div>

                          <!-- Options -->
                          <div class="options">
                            <!-- Column 1: Stops/Amenities -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-plane-departure"></i>
                                  <span>{{ getStopsCount(flight) === 0 ? 'Non-stop' : getStopsCount(flight) + ' Stop' +
                                    (getStopsCount(flight) > 1 ? 's' : '') }}</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-list-alt"></i>
                                  <span>Flight Details</span>
                                  <div class="dropdown-content">
                                    {{ getStopsSummary(flight) }} - Duration: {{ getTotalDuration(flight.Segments[0]) }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 2: Baggage/Instructions -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-suitcase"></i>
                                  <span>Baggage</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-info-circle"></i>
                                  <span>Details</span>
                                  <div class="dropdown-content">
                                    Check-in: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.Baggage || '15kg' }}<br>
                                    Cabin: {{ selectedFareOptions[i]?.Segments?.[0]?.[0]?.CabinBaggage || '7kg' }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 3: Policy/Cancellation Policy -->
                            <div class="option-item">
                              <div class="default-amenities">
                                <div class="amenity-item">
                                  <i class="fas fa-ban"></i>
                                  <span>Policy</span>
                                </div>
                              </div>
                              <div class="hover-dropdowns">
                                <div class="dropdown">
                                  <i class="fas fa-ban"></i>
                                  <span>Cancellation</span>
                                  <div class="dropdown-content">
                                    {{ getCancellationRule(selectedFareOptions[i] || flight.FareOptions[0]) }}
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- Column 4: Price & View Prices Button -->
                            <div class="select-btn-card">
                              <div class="desktop-price-display">
                                <span class="price-label">Starts from</span>
                                <span class="price-value">₹ {{ flight.price | number : "1.0-0" }}</span>
                              </div>
                              <button class="btn"
                                (click)="openFareOptionsModalForRoundTrip(flight, i, 'return'); $event.stopPropagation()">View
                                Prices</button>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>

                    <!-- Footer for Selected Onward Flight -->
                    <div class="selected-flight-card-dark"
                      *ngIf="flightType === 'round' && activeTab === 'return' && selectedOutboundFooter">
                      <div class="flight-row-header">✅ Selected Onward Flight</div>

                      <!-- Loop over segments -->
                      <div class="segment-list">
                        <div class="segment-row" *ngFor="
                            let seg of selectedOutboundFooter.Segments[0];
                            let i = index;
                            let last = last
                          ">
                          <div class="segment-left">
                            <img [src]="'assets/images/flightimages/' + seg?.Airline?.AirlineCode + '.png'"
                              class="airline-logo" alt="logo" onerror="this.src='assets/images/default-airline.png'" />
                            <span class="flight-code">
                              {{ seg?.Airline?.AirlineCode }}
                              {{ seg?.Airline?.FlightNumber }}
                            </span>
                            <span>
                              {{ seg?.Origin?.Airport?.AirportCode }}
                              <i class="fas fa-plane-arrival planemargin"></i>
                              {{ seg?.Destination?.Airport?.AirportCode }}
                            </span>

                            <!-- Only show Stop & Duration on last row -->
                            <span *ngIf="last" class="stop-duration-inline">
                              &nbsp;
                              {{ selectedOutboundFooter.Segments[0].length - 1 > 0 ?
                              (selectedOutboundFooter.Segments[0].length - 1) + ' Stop |' : '0 Stop |' }}
                              <strong>Duration:</strong>
                              {{ getTotalDurationForFlight(selectedOutboundFooter) }}
                            </span>
                          </div>

                          <!-- First segment gets Dep Time -->
                          <div class="segment-right" *ngIf="i === 0">
                            <strong>Dep. Time:</strong>
                            {{ seg?.Origin?.DepTime | date : "HH:mm" }}
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- No Flights Messages -->
                    <div class="no-flights"
                      *ngIf="(!groupedFlightsOutbound || groupedFlightsOutbound.length === 0) && !loader">
                      <h3>No Return Flights Found</h3>
                      <p>No return flights found for your search criteria. Please try modifying your search.</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- No Flights Message for Onward -->
              <div class="no-flights"
                *ngIf="activeTab === 'onward' && (!groupedFlights || groupedFlights.length === 0) && !loader">
                <h3>No Onward Flights Found</h3>
                <p>No onward flights found for your search criteria. Please try modifying your search.</p>
              </div>

              <!-- Expandable Flight Details Section -->
              <div class="footer-expand-section" *ngIf="expandedFlightDetailsBothway">
                <div class="footer-expand-inner">
                  <div class="footer-expand-tabs">
                    <div class="tab" [class.active]="expandedTypeBothway === 'departure'"
                      (click)="toggleBothFlightDetails('departure')">Departure</div>
                    <div class="tab" [class.active]="expandedTypeBothway === 'return'"
                      (click)="toggleBothFlightDetails('return')">Return</div>
                  </div>

                  <!-- DEPARTURE DETAILS TAB SECTION -->
                  <div class="footer-tab-content" *ngIf="expandedTypeBothway === 'departure'">
                    <div class="flight-list-extention-div1">
                      <div class="flight-tabs">
                        <div class="tab" *ngFor="let tab of tabsBoth"
                          [class.active]="footerTabBothwayOutbound === tab.id"
                          (click)="setFooterTabBothwayOutbound(tab.id)">
                          {{ tab.label }}
                        </div>
                      </div>

                      <!-- Flight Tab -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayOutbound === 'flight'">
                        <div class="tab-heading">
                          {{ selectedOutbound.Origin.Airport.CityName }} to {{
                          selectedOutbound.Destination.Airport.CityName }},
                          {{ selectedOutbound.Origin.DepTime | date : "mediumDate" }}
                        </div>
                        <ng-container *ngFor="let segment of selectedOutbound.Segments[0]; let i = index">
                          <div class="tab-content-section">
                            <div class="flight-info">
                              <img [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                width="40" height="40" />
                              <strong>{{ segment.Airline.AirlineName }}</strong> {{ segment.Airline.FlightNumber }}
                              <div class="tag">{{ segment.Craft }}</div>
                            </div>
                            <div class="timing-row">
                              <div class="time-block">
                                <div class="time">{{ segment.Origin.DepTime | date : "shortTime" }}</div>
                                <div class="date">{{ segment.Origin.DepTime | date : "mediumDate" }}</div>
                                <div class="terminal">
                                  Terminal - {{ segment.Origin.Airport.Terminal || "-" }}<br />
                                  {{ segment.Origin.Airport.CityName }}
                                </div>
                              </div>
                              <div class="duration">{{ segment.Duration / 60 | number : "1.0-0" }}h {{ segment.Duration
                                % 60 }}m</div>
                              <div class="time-block">
                                <div class="time">{{ segment.Destination.ArrTime | date : "shortTime" }}</div>
                                <div class="date">{{ segment.Destination.ArrTime | date : "mediumDate" }}</div>
                                <div class="terminal">
                                  Terminal - {{ segment.Destination.Airport.Terminal || "-" }}<br />
                                  {{ segment.Destination.Airport.CityName }}
                                </div>
                              </div>
                            </div>
                            <div class="baggage-info">
                              <div><strong>BAGGAGE:</strong> ADULT</div>
                              <div><strong>CHECK IN : </strong>{{ segment.Baggage || "N/A" }}</div>
                              <div><strong>CABIN : </strong>{{ segment.CabinBaggage || "N/A" }}</div>
                            </div>
                          </div>
                          <div *ngIf="i < selectedOutbound.Segments[0].length - 1" class="layover-banner">
                            <div class="layover-label">Change of planes</div>
                            <div class="layover-text">
                              <strong>{{ getLayoverFormattedDuration(selectedOutbound.Segments[0][i],
                                selectedOutbound.Segments[0][i + 1]) }}</strong>
                              Layover in {{ segment.Destination.Airport.CityName }}
                            </div>
                          </div>
                        </ng-container>
                      </div>

                      <!-- Fare Summary -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayOutbound === 'fare'">
                        <div class="tab-heading">Fare Summary</div>
                        <table class="fare-summary-table">
                          <tr>
                            <th>Total</th>
                            <td><strong>₹ {{ (selectedOutbound.FareOptions[0]?.Fare?.BaseFare +
                                selectedOutbound.FareOptions[0]?.Fare?.Tax) | number : "1.0-0" }}</strong></td>
                          </tr>
                          <tr>
                            <th>Base Fare</th>
                            <td>₹ {{ selectedOutbound.FareOptions[0]?.Fare?.BaseFare | number : "1.0-0" }}</td>
                          </tr>
                          <tr>
                            <th>Surcharges</th>
                            <td>₹ {{ selectedOutbound.FareOptions[0]?.Fare?.Tax | number : "1.0-0" }}</td>
                          </tr>
                        </table>
                      </div>

                      <!-- Cancellation -->
                      <div class="flight-tab-content"
                        *ngIf="footerTabBothwayOutbound === 'cancellation' && selectedOutbound.isRefundable">
                        <div class="tab-heading">Cancellation Policy</div>
                        <table class="cancellation-policy-table">
                          <thead>
                            <tr>
                              <th>Route</th>
                              <th>Time Frame</th>
                              <th>Airline + Wizzride Fee</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let policy of selectedOutbound.FareOptions[0]?.cancellationPolicy">
                              <td>{{ selectedOutbound.Origin.Airport.CityName }} - {{
                                selectedOutbound.Destination.Airport.CityName }}</td>
                              <td>{{ policy.From }} {{ policy.Unit?.toLowerCase() }} to {{ policy.To || "departure" }}
                                {{ policy.Unit?.toLowerCase() }}</td>
                              <td><strong>ADULT:</strong> {{ policy.Details }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <div class="disclaimer-note">*From the Time of Departure</div>
                      </div>

                      <!-- Date Change -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayOutbound === 'dateChange'">
                        <div class="tab-heading">Date Change Policy</div>
                        <table class="change-policy-table">
                          <thead>
                            <tr>
                              <th>Route</th>
                              <th>Time Frame</th>
                              <th>Fee + Fare Difference</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let change of selectedOutbound.FareOptions[0]?.dateChangePolicy">
                              <td>{{ selectedOutbound.Origin.Airport.CityName }} - {{
                                selectedOutbound.Destination.Airport.CityName }}</td>
                              <td>{{ change.From }} {{ change.Unit?.toLowerCase() }} to {{ change.To || "departure" }}
                                {{ change.Unit?.toLowerCase() }}</td>
                              <td><strong>ADULT:</strong> {{ change.Details }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <div class="disclaimer-note">
                          *From the Time of Departure<br /><br />
                          <strong>Important:</strong> The airline fee is indicative. Wizzride does not guarantee
                          accuracy.
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- RETURN DETAILS TAB SECTION -->
                  <div class="footer-tab-content" *ngIf="expandedTypeBothway === 'return'">
                    <div class="flight-list-extention-div1">
                      <div class="flight-tabs">
                        <div class="tab" *ngFor="let tab of tabsBoth" [class.active]="footerTabBothwayReturn === tab.id"
                          (click)="setFooterTabBothwayReturn(tab.id)">
                          {{ tab.label }}
                        </div>
                      </div>

                      <!-- Flight Tab -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayReturn === 'flight'">
                        <div class="tab-heading">
                          {{ selectedReturn.Origin.Airport.CityName }} to {{ selectedReturn.Destination.Airport.CityName
                          }},
                          {{ selectedReturn.Origin.DepTime | date : "mediumDate" }}
                        </div>
                        <ng-container *ngFor="let segment of selectedReturn.Segments[0]; let i = index">
                          <div class="tab-content-section">
                            <div class="flight-info">
                              <img [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                                width="40" height="40" />
                              <strong>{{ segment.Airline.AirlineName }}</strong> {{ segment.Airline.FlightNumber }}
                              <div class="tag">{{ segment.Craft }}</div>
                            </div>
                            <div class="timing-row">
                              <div class="time-block">
                                <div class="time">{{ segment.Origin.DepTime | date : "shortTime" }}</div>
                                <div class="date">{{ segment.Origin.DepTime | date : "mediumDate" }}</div>
                                <div class="terminal">
                                  Terminal - {{ segment.Origin.Airport.Terminal || "-" }}<br />
                                  {{ segment.Origin.Airport.CityName }}
                                </div>
                              </div>
                              <div class="duration">{{ segment.Duration / 60 | number : "1.0-0" }}h {{ segment.Duration
                                % 60 }}m</div>
                              <div class="time-block">
                                <div class="time">{{ segment.Destination.ArrTime | date : "shortTime" }}</div>
                                <div class="date">{{ segment.Destination.ArrTime | date : "mediumDate" }}</div>
                                <div class="terminal">
                                  Terminal - {{ segment.Destination.Airport.Terminal || "-" }}<br />
                                  {{ segment.Destination.Airport.CityName }}
                                </div>
                              </div>
                            </div>
                            <div class="baggage-info">
                              <div><strong>BAGGAGE:</strong> ADULT</div>
                              <div><strong>CHECK IN : </strong>{{ segment.Baggage || "N/A" }}</div>
                              <div><strong>CABIN : </strong>{{ segment.CabinBaggage || "N/A" }}</div>
                            </div>
                          </div>
                          <div *ngIf="i < selectedReturn.Segments[0].length - 1" class="layover-banner">
                            <div class="layover-label">Change of planes</div>
                            <div class="layover-text">
                              <strong>{{ getLayoverFormattedDuration(selectedReturn.Segments[0][i],
                                selectedReturn.Segments[0][i + 1]) }}</strong>
                              Layover in {{ segment.Destination.Airport.CityName }}
                            </div>
                          </div>
                        </ng-container>
                      </div>

                      <!-- Fare Summary -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayReturn === 'fare'">
                        <div class="tab-heading">Fare Summary</div>
                        <table class="fare-summary-table">
                          <tr>
                            <th>Total</th>
                            <td><strong>₹ {{ (selectedReturn.FareOptions[0]?.Fare?.BaseFare +
                                selectedReturn.FareOptions[0]?.Fare?.Tax) | number : "1.0-0" }}</strong></td>
                          </tr>
                          <tr>
                            <th>Base Fare</th>
                            <td>₹ {{ selectedReturn.FareOptions[0]?.Fare?.BaseFare | number : "1.0-0" }}</td>
                          </tr>
                          <tr>
                            <th>Surcharges</th>
                            <td>₹ {{ selectedReturn.FareOptions[0]?.Fare?.Tax | number : "1.0-0" }}</td>
                          </tr>
                        </table>
                      </div>

                      <!-- Cancellation -->
                      <div class="flight-tab-content"
                        *ngIf="footerTabBothwayReturn === 'cancellation' && selectedReturn.isRefundable">
                        <div class="tab-heading">Cancellation Policy</div>
                        <table class="cancellation-policy-table">
                          <thead>
                            <tr>
                              <th>Route</th>
                              <th>Time Frame</th>
                              <th>Airline + Wizzride Fee</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let policy of selectedReturn.FareOptions[0]?.cancellationPolicy">
                              <td>{{ selectedReturn.Origin.Airport.CityName }} - {{
                                selectedReturn.Destination.Airport.CityName }}</td>
                              <td>{{ policy.From }} {{ policy.Unit?.toLowerCase() }} to {{ policy.To || "departure" }}
                                {{ policy.Unit?.toLowerCase() }}</td>
                              <td><strong>ADULT:</strong> {{ policy.Details }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <div class="disclaimer-note">*From the Time of Departure</div>
                      </div>

                      <!-- Date Change -->
                      <div class="flight-tab-content" *ngIf="footerTabBothwayReturn === 'dateChange'">
                        <div class="tab-heading">Date Change Policy</div>
                        <table class="change-policy-table">
                          <thead>
                            <tr>
                              <th>Route</th>
                              <th>Time Frame</th>
                              <th>Fee + Fare Difference</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let change of selectedReturn.FareOptions[0]?.dateChangePolicy">
                              <td>{{ selectedReturn.Origin.Airport.CityName }} - {{
                                selectedReturn.Destination.Airport.CityName }}</td>
                              <td>{{ change.From }} {{ change.Unit?.toLowerCase() }} to {{ change.To || "departure" }}
                                {{ change.Unit?.toLowerCase() }}</td>
                              <td><strong>ADULT:</strong> {{ change.Details }}</td>
                            </tr>
                          </tbody>
                        </table>
                        <div class="disclaimer-note">
                          *From the Time of Departure<br /><br />
                          <strong>Important:</strong> The airline fee is indicative. Wizzride does not guarantee
                          accuracy.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Multi-City Flights -->
        <div *ngIf="flightType === 'multi'">
            <div class="results-layout" *ngIf="multicityTabData && multicityTabData.length > 0">
              <!-- Filter Sidebar for Multi-City (Desktop) -->
              <div class="filter-sidebar-column" *ngIf="flightType === 'multi'">
                <div class="filter-card">
                  <h2 class="filter-heading">Filter Flights</h2>

                  <!-- Airlines Filter -->
                  <div class="filter-section">
                    <h3 class="filter-subheading">Airlines</h3>
                    <label class="filter-option" *ngFor="let airline of dynamicFilters.airlines">
                      <input type="checkbox" [value]="airline" (change)="onAirlineFilterChange($event)" />
                      {{ airline }}
                    </label>
                  </div>

                  <!-- Price Range Filter -->
                  <div class="filter-section">
                    <h3 class="filter-subheading">Price Range</h3>
                    <input type="range" [min]="dynamicFilters.min_price" [max]="dynamicFilters.max_price"
                      [(ngModel)]="priceRange" class="price-range" (input)="onPriceChange()" />
                    <div class="price-range-label">
                      ₹{{ dynamicFilters.min_price | number : "1.0-0" }} - ₹{{ priceRange | number : "1.0-0" }}
                    </div>
                  </div>

                  <!-- Number of Stops Filter -->
                  <div class="filter-section">
                    <h3 class="filter-subheading">Number of Stops</h3>
                    <label class="filter-option" *ngFor="let stop of dynamicFilters.stops">
                      <input type="checkbox" [value]="stop" (change)="onStopFilterChange($event)" />
                      {{ stop === 0 ? "Non-stop" : stop + " Stop" + (stop > 1 ? "s" : "") }}
                    </label>
                  </div>

                  <!-- Departure Time Filter -->
                  <div class="filter-section">
                    <h3 class="filter-subheading">Departure From {{ getMultiCityRouteOrigin(selectedMulticityTab) }}</h3>
                    <div class="departure-time-filter">
                      <div class="time-slot" *ngFor="let slot of departureTimeSlots"
                        (click)="toggleDepartureSlot(slot.label)" [class.selected]="selectedDepartureSlots.has(slot.label)">
                        <i [class]="slot.iconClass"></i>
                        <div class="label">{{ slot.label }}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Refundability Filter -->
                  <div class="filter-section">
                    <h3 class="filter-subheading">Refundability</h3>
                    <label class="filter-option">
                      <input type="checkbox" value="refundable" (change)="onRefundabilityChange($event)" />
                      Partially Refundable
                    </label>
                    <label class="filter-option">
                      <input type="checkbox" value="non-refundable" (change)="onRefundabilityChange($event)" />
                      Non-refundable
                    </label>
                  </div>
                </div>
              </div>

              <!-- Results Column for Multi-City -->
              <div class="results-column">
                <div class="flight-list-container" *ngIf="multicityTabData && multicityTabData.length > 0">
                  <!-- Flight Cards - Show all segments in one card (like mobile but desktop design) -->
                  <div class="flight-cards" *ngIf="multicityTabData && multicityTabData[0] && multicityTabData[0].groupedFlights && multicityTabData[0].groupedFlights.length > 0">
                    <div class="card mobile-flight-card-new multicity-combined-card" 
                      [class.selected]="multicitySelectedFares[0]?.groupedFlight === flight"
                      *ngFor="let flight of multicityTabData[0].groupedFlights; let i = index">

                      <!-- DESKTOP MULTI-CITY CARD - All Segments in One Card -->
                      <div class="desktop-multicity-card" *ngIf="flight && flight.Segments" (click)="selectMulticityFlight(0, i, flight); $event.stopPropagation()">
                        <!-- Show all segments one below another -->
                        <ng-container *ngFor="let segmentGroup of flight.Segments; let segIndex = index">
                          <div class="desktop-multicity-segment" *ngIf="segmentGroup && segmentGroup[0] && segmentGroup[0].Origin" [class.last-segment]="segIndex === flight.Segments.length - 1">
                            <!-- Route Header -->
                            <div class="multicity-segment-header">
                              <span class="route-label">Route {{ segIndex + 1 }}: {{ segmentGroup[0].Origin.Airport.CityName }} ({{ segmentGroup[0].Origin.Airport.AirportCode }}) → {{ segmentGroup[segmentGroup.length - 1].Destination.Airport.CityName }} ({{ segmentGroup[segmentGroup.length - 1].Destination.Airport.AirportCode }})</span>
                              <span class="route-date">{{ segmentGroup[0].Origin.DepTime | date : "d MMM, yyyy" }}</span>
                            </div>
                            
                            <!-- Desktop Flight Row for this segment -->
                            <div class="desktop-flight-row">
                              <!-- Airline Section -->
                              <div class="desktop-airline-section">
                                <img class="desktop-airline-logo"
                                  [src]="'assets/images/flightimages/' + segmentGroup[0].Airline.AirlineCode + '.png'"
                                  [alt]="segmentGroup[0].Airline.AirlineName"
                                  onerror="this.src='assets/images/default-airline.png'" />
                                <div class="desktop-airline-info">
                                  <div class="desktop-airline-name">{{ segmentGroup[0].Airline.AirlineName }}</div>
                                  <div class="desktop-flight-number">{{ segmentGroup[0].Airline.AirlineCode }} {{ segmentGroup[0].Airline.FlightNumber }}</div>
                                  <div class="desktop-aircraft-type">{{ segmentGroup[0].Craft || 'Aircraft' }}</div>
                                </div>
                              </div>

                              <!-- Departure Section -->
                              <div class="desktop-departure-section">
                                <div class="desktop-time">{{ segmentGroup[0].Origin.DepTime | date : "HH:mm" }}</div>
                                <div class="desktop-date">{{ segmentGroup[0].Origin.DepTime | date : "EEE, dd MMM" }}</div>
                                <div class="desktop-airport">{{ segmentGroup[0].Origin.Airport.CityName }}</div>
                              </div>

                              <!-- Duration & Stops Section -->
                              <div class="desktop-duration-section">
                                <div class="desktop-duration-text">{{ getTotalDuration(segmentGroup) }}</div>
                                <div class="desktop-stops-text">{{ (segmentGroup.length - 1) === 0 ? 'Non Stop' : (segmentGroup.length - 1) + ' Stop' + ((segmentGroup.length - 1) > 1 ? 's' : '') }}</div>
                              </div>

                              <!-- Arrival Section -->
                              <div class="desktop-arrival-section">
                                <div class="desktop-time">{{ segmentGroup[segmentGroup.length - 1].Destination.ArrTime | date : "HH:mm" }}</div>
                                <div class="desktop-date">{{ segmentGroup[segmentGroup.length - 1].Destination.ArrTime | date : "EEE, dd MMM" }}</div>
                                <div class="desktop-airport">{{ segmentGroup[segmentGroup.length - 1].Destination.Airport.CityName }}</div>
                                <div class="desktop-day-diff" *ngIf="getDayDiff(segmentGroup[0].Origin.DepTime, segmentGroup[segmentGroup.length - 1].Destination.ArrTime) > 0">
                                  +{{ getDayDiff(segmentGroup[0].Origin.DepTime, segmentGroup[segmentGroup.length - 1].Destination.ArrTime) }} day
                                </div>
                              </div>
                            </div>
                          </div>
                        </ng-container>

                        <!-- Price & Button Section (at bottom of card) -->
                        <div class="desktop-price-section multicity-total-price">
                          <div class="desktop-price-amount">₹ {{ flight.price | number : "1.0-0" }}</div>
                          <div class="desktop-price-label">Total per Adult</div>
                          <button class="desktop-view-prices-btn" (click)="openFareOptionsModalMultiCity(0, flight, i); $event.stopPropagation()">
                            View Prices
                          </button>
                        </div>
                      </div>
                      <!-- END DESKTOP MULTI-CITY CARD -->

                  <!-- MOBILE FLIGHT CARD DESIGN (matching reference) - Hidden on Desktop -->
                  <div class="mobile-only">
                  <ng-container *ngIf="flight.Segments.length > 1; else singleSegmentBlockMultiCity">
                    <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                      (click)="openFareOptionsModalMultiCity(selectedMulticityTab, flight, i); $event.stopPropagation()">
                      <ng-container *ngFor="let group of flight.Segments; let groupIndex = index">
                        <ng-container *ngFor="let segment of normalizeGroupToArray(group); let segIndex = index">
                        <div class="flight-card-component__flight-leg">
                          <div class="flight-card-component__leg-header">
                            <img class="flight-card-component__airline-logo"
                              [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                              [alt]="segment.Airline.AirlineName + ' logo'"
                              onerror="this.src='assets/images/default-airline.png'" />
                            <div class="flight-card-component__airline-name">
                              {{ segment.Airline.AirlineName }}
                            </div>
                            <div class="flight-card-component__flight-code">
                              {{ segment.Airline.AirlineCode }} {{ segment.Airline.FlightNumber }}
                            </div>
                            <div class="flight-card-component__pill">
                              {{ segment.Craft || 'Aircraft' }}
                            </div>
                          </div>

                          <div class="flight-card-component__flight-row">
                            <div class="flight-card-component__flight-left">
                              <div class="flight-card-component__time">
                                {{ segment.Origin.DepTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Origin.DepTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Origin.Airport.CityName }}
                                <div class="flight-card-component_country-name">
                                  {{ segment.Origin.Airport.CountryName }}
                                </div>
                              </div>
                            </div>

                            <div class="flight-card-component__flight-icon">
                              <i class="fas fa-plane"></i>
                              <div class="flight-card-component__duration">
                                {{ formatMinutesToHrMin(segment.Duration) }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-right">
                              <div class="flight-card-component__day-diff"
                                *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }}
                                day
                              </div>
                              <div class="flight-card-component__time">
                                {{ segment.Destination.ArrTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Destination.ArrTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Destination.Airport.CityName }}
                                <div class="flight-card-component_country-name">
                                  {{ segment.Destination.Airport.CountryName }}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Layover Section -->
                        <div *ngIf="segIndex < normalizeGroupToArray(group).length - 1" class="flight-card-component__layover-row">
                          <div class="flight-card-component__dotted-line"></div>
                          <div class="flight-card-component__layover">
                            <div class="flight-card-component__layover-day">
                              {{ getLayoverDayText(normalizeGroupToArray(group)[segIndex], normalizeGroupToArray(group)[segIndex + 1]) }}
                            </div>
                            <div class="flight-card-component__layover-time">
                              {{ getLayoverDuration(normalizeGroupToArray(group)[segIndex], normalizeGroupToArray(group)[segIndex + 1]) }}
                            </div>
                          </div>
                          <div class="flight-card-component__dotted-line"></div>
                        </div>
                        </ng-container>

                        <!-- Badges for each group -->
                        <div class="flight-card-component__badges__intreturn" *ngIf="normalizeGroupToArray(group).length > 0">
                          <span class="flight-card-component__pill">
                            {{ normalizeGroupToArray(group).length - 1 === 0 ? "Non Stop" : normalizeGroupToArray(group).length - 1 + " Stop" }}
                          </span>
                          <span class="flight-card-component__pill">
                            {{ getGroupDuration(normalizeGroupToArray(group)) }}
                          </span>
                        </div>

                        <!-- Separator between segment groups -->
                        <div *ngIf="groupIndex < flight.Segments.length - 1" class="flight-card-component__group-separator">
                          <div class="flight-card-component__dotted-line"></div>
                        </div>
                      </ng-container>

                      <!-- Footer -->
                      <div class="flight-card-component__footer">
                        <div class="flight-card-component__badges">
                        </div>
                        <div class="flight-card-component__price">
                          <div class="flight-card-component__amount">
                            ₹ {{ flight.price | number : "1.2-2" }}
                          </div>
                          <div class="flight-card-component__per">per Adult</div>
                        </div>
                        <button class="flight-card-component__view-prices-btn desktop-only"
                          (click)="openFareOptionsModalMultiCity(selectedMulticityTab, flight, i); $event.stopPropagation()">
                          View Prices
                        </button>
                      </div>
                    </section>
                  </ng-container>

                  <!-- Single Segment Block -->
                  <ng-template #singleSegmentBlockMultiCity>
                    <section class="flight-card-component__flight-card mobile-card-clickable" aria-label="Flight Option"
                      (click)="openFareOptionsModalMultiCity(selectedMulticityTab, flight, i); $event.stopPropagation()">
                      <ng-container *ngFor="let segment of flight.Segments[0]; let segIndex = index">
                        <div class="flight-card-component__flight-leg">
                          <div class="flight-card-component__leg-header">
                            <img class="flight-card-component__airline-logo"
                              [src]="'assets/images/flightimages/' + segment.Airline.AirlineCode + '.png'"
                              [alt]="segment.Airline.AirlineName + ' logo'"
                              onerror="this.src='assets/images/default-airline.png'" />
                            <div class="flight-card-component__airline-name">
                              {{ segment.Airline.AirlineName }}
                            </div>
                            <div class="flight-card-component__flight-code">
                              {{ segment.Airline.AirlineCode }} {{ segment.Airline.FlightNumber }}
                            </div>
                            <div class="flight-card-component__pill">
                              {{ segment.Craft || 'Aircraft' }}
                            </div>
                          </div>

                          <div class="flight-card-component__flight-row">
                            <div class="flight-card-component__flight-left">
                              <div class="flight-card-component__time">
                                {{ segment.Origin.DepTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Origin.DepTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Origin.Airport.CityName }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-icon">
                              <i class="fas fa-plane"></i>
                              <div class="flight-card-component__duration">
                                {{ formatMinutesToHrMin(segment.Duration) }}
                              </div>
                            </div>

                            <div class="flight-card-component__flight-right">
                              <div class="flight-card-component__day-diff"
                                *ngIf="getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) > 0">
                                +{{ getDayDiff(segment.Origin.DepTime, segment.Destination.ArrTime) }}
                                day
                              </div>
                              <div class="flight-card-component__time">
                                {{ segment.Destination.ArrTime | date : "HH:mm" }}
                              </div>
                              <div class="flight-card-component__date">
                                {{ segment.Destination.ArrTime | date : "EEE, dd MMM" }}
                              </div>
                              <div class="flight-card-component__location">
                                {{ segment.Destination.Airport.CityName }}
                              </div>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="segIndex < flight.Segments[0].length - 1" class="flight-card-component__layover-row">
                          <div class="flight-card-component__dotted-line"></div>
                          <div class="flight-card-component__layover">
                            <div class="flight-card-component__layover-day">
                              {{ getLayoverDayText(flight.Segments[0][segIndex], flight.Segments[0][segIndex + 1]) }}
                            </div>
                            <div class="flight-card-component__layover-time">
                              {{ getLayoverDuration(flight.Segments[0][segIndex], flight.Segments[0][segIndex + 1]) }}
                            </div>
                          </div>
                          <div class="flight-card-component__dotted-line"></div>
                        </div>
                      </ng-container>

                      <div class="flight-card-component__footer">
                        <div class="flight-card-component__badges">
                          <span class="flight-card-component__pill">
                            {{ flight.Segments[0].length - 1 === 0 ? "Non Stop" : flight.Segments[0].length - 1 + " Stop" }}
                          </span>
                          <span class="flight-card-component__pill">
                            {{ getTotalDuration(flight.Segments[0]) }}
                          </span>
                        </div>
                        <div class="flight-card-component__price">
                          <div class="flight-card-component__amount">
                            ₹ {{ flight.price | number : "1.2-2" }}
                          </div>
                          <div class="flight-card-component__per">per Adult</div>
                        </div>
                        <button class="flight-card-component__view-prices-btn desktop-only"
                          (click)="openFareOptionsModalMultiCity(selectedMulticityTab, flight, i); $event.stopPropagation()">
                          View Prices
                        </button>
                      </div>
                    </section>
                  </ng-template>
                  </div>
                </div>
              </div>

                  <!-- No Flights Message -->
                  <div class="no-flights"
                    *ngIf="(!multicityTabData || !multicityTabData[0] || !multicityTabData[0].groupedFlights || multicityTabData[0].groupedFlights.length === 0) && !loader">
                    <p>No flights found for your multi-city search. Please try modifying your search.</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Multi-City Summary Footer -->
            <div class="multicity-summary-footer" *ngIf="multicityTabData && multicityTabData.length > 0">
              <div class="summary-total">
                <span class="total-label">Total Price:</span>
                <span class="total-amount">₹ {{ multicityTotalFare | number : "1.0-0" }}</span>
              </div>
              <button class="proceed-btn" [class.disabled]="!multicityHasSelectedFares"
                [disabled]="!multicityHasSelectedFares" (click)="proceedWithMultiCityBooking()">
                {{ multicityHasSelectedFares ? 'Proceed to Booking' : 'Select All Segments' }}
              </button>
            </div>
          </div>

      </div>
    </main>

    <!-- Fare Options Modal - One Way -->
    <div class="custom-modal-overlay" *ngIf="showFareModal" (click)="closeFareOptionsModal()">
      <div class="custom-modal" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeFareOptionsModal()">&times;</button>
        <div class="fare-options-box">
          <div class="fare-options-header">
            <div class="fare-options-title">Fare Options available for your trip</div>
            <div class="fare-options-subtitle-line" *ngIf="selectedFlight">
              <span class="fare-trip-details-text">{{ selectedFlight.Origin?.Airport?.CityName }} → {{
                selectedFlight.Destination?.Airport?.CityName }} · {{ selectedFlight.Airline?.AirlineName }} · {{
                selectedFlight.Origin?.DepTime | date : "EEE, dd MMM y" }} · {{ selectedFlight.Origin?.DepTime | date :
                "HH:mm" }} - {{ selectedFlight.Destination?.ArrTime | date : "HH:mm" }}</span>
              <button class="fare-modify-btn"
                (click)="showModifyForm = !showModifyForm; closeFareOptionsModal(); $event.stopPropagation()"
                title="Modify">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
          <div class="fare-scroll-wrapper">
            <button class="scroll-arrow left" (click)="scrollFareCards('left')">‹</button>
            <div class="fare-scroll-container" #fareScrollContainer>
              <div class="fare-card" *ngFor="let fare of selectedFlight?.FareOptions">
                <div class="fare-price-oneway">
                  ₹ {{ getAdultFarePerPerson(fare.FareBreakdown) | number : "1.0-0" }}
                  <span class="per-adult">per adult</span>
                </div>
                <div class="fare-type">{{ fare.Segments[0][0].SupplierFareClass }}</div>
                <div class="fare-section">
                  <strong>Baggage</strong>
                  <ul>
                    <li>✅ Cabin: {{ fare.Segments[0][0].CabinBaggage }}</li>
                    <li>✅ Check-in: {{ fare.Segments[0][0].Baggage }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Flexibility</strong>
                  <ul>
                    <li>⚠️ Cancel: {{ getCancellationRule(fare) }}</li>
                    <li>⚠️ Change: {{ getDateChangeRule(fare) }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Seats, Meals & More</strong>
                  <ul>
                    <li>🍽️ Meals: {{ fare.IsFreeMealAvailable ? "Free meal available" : "Meal not included" }}</li>
                    <li>💺 Seats: {{ fare.AirlineRemark?.toLowerCase().includes('standard seats are free') ? "Standard
                      seats free" : "Chargeable seats" }}</li>
                    <li>{{ fare.FareRules[0]?.Details || "Check with airline" }}</li>
                  </ul>
                </div>
                <button class="book-btn" (click)="finalizeSelection(fare)">BOOK NOW</button>
              </div>
            </div>
            <button class="scroll-arrow right" (click)="scrollFareCards('right')">›</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fare Options Modal - Round Trip (using same structure as one-way) -->
    <div class="custom-modal-overlay" *ngIf="showFareModal && flightType === 'round'" (click)="closeFareOptionsModal()">
      <div class="custom-modal" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeFareOptionsModal()">&times;</button>
        <div class="fare-options-box">
          <div class="fare-options-header">
            <div class="fare-options-title">Fare Options available for your trip</div>
            <div class="fare-options-subtitle-line" *ngIf="selectedFlight">
              <span class="fare-trip-details-text">
                {{ selectedFlight?.Segments?.[0]?.[0]?.Origin?.Airport?.CityName }} →
                {{ selectedFlight?.Segments?.[0]?.[selectedFlight?.Segments?.[0]?.length -
                1]?.Destination?.Airport?.CityName }} ·
                {{ selectedFlight?.Segments?.[0]?.[0]?.Airline?.AirlineName }} ·
                {{ selectedFlight?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "EEE, dd MMM y" }} ·
                {{ selectedFlight?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "HH:mm" }} -
                {{ selectedFlight?.Segments?.[0]?.[selectedFlight?.Segments?.[0]?.length - 1]?.Destination?.ArrTime |
                date : "HH:mm" }}
              </span>
              <button class="fare-modify-btn"
                (click)="showModifyForm = !showModifyForm; closeFareOptionsModal(); $event.stopPropagation()"
                title="Modify">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
          <div class="fare-scroll-wrapper">
            <button class="scroll-arrow left" (click)="scrollFareCards('left')">‹</button>
            <div class="fare-scroll-container" #fareScrollContainer>
              <div class="fare-card" *ngFor="let fare of defaultFares">
                <div class="fare-price-oneway">
                  ₹ {{ fare.price | number : "1.0-0" }}
                  <span class="per-adult">per adult</span>
                </div>
                <div class="fare-type">{{ fare.type }}</div>
                <div class="fare-section">
                  <strong>Baggage</strong>
                  <ul>
                    <li>✅ Cabin: {{ fare.cabin }}</li>
                    <li>✅ Check-in: {{ fare.checkIn }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Flexibility</strong>
                  <ul>
                    <li>⚠️ Cancel: {{ fare.cancel }}</li>
                    <li>⚠️ Change: {{ fare.dateChange }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Seats, Meals & More</strong>
                  <ul>
                    <li>🍽️ Meals: {{ fare.meal === 'Included' ? "Free meal available" : "Meal not included" }}</li>
                    <li>💺 Seats: {{ fare.seat === 'Free' ? "Standard seats free" : "Chargeable seats" }}</li>
                  </ul>
                </div>
                <button class="book-btn" (click)="finalizeBookingForRoundTrip(selectedFlight, fare)">
                  BOOK NOW
                </button>
              </div>
            </div>
            <button class="scroll-arrow right" (click)="scrollFareCards('right')">›</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Old Round Trip Modal (keeping for backward compatibility) -->
    <div class="custom-modal-overlay" *ngIf="showFareModalBoth" (click)="closeFareOptionsModalBothWay()">
      <div class="custom-modal" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeFareOptionsModalBothWay()">×</button>
        <div class="fare-options-box">
          <div class="fare-options-header">
            <div class="fare-options-title"><strong>MORE FARE OPTIONS</strong> available for your round trip.</div>
            <!-- Tabs for ONWARD and RETURN -->
            <div class="flight-tabs">
              <div class="tab" [class.active]="activeFareTab === 'departure'" (click)="selectFareTab('departure')">
                ONWARD</div>
              <div class="tab" [class.active]="activeFareTab === 'return'" (click)="selectFareTab('return')">RETURN
              </div>
            </div>
            <!-- Fare Subtitle -->
            <div class="fare-options-subtitle-line" *ngIf="activeFareTab === 'departure' && selectedOutbound">
              <span class="fare-trip-details-text">
                {{ selectedOutbound?.Segments?.[0]?.[0]?.Origin?.Airport?.CityName }} →
                {{ selectedOutbound?.Segments?.[0]?.[selectedOutbound?.Segments?.[0]?.length -
                1]?.Destination?.Airport?.CityName }} ·
                {{ selectedOutbound?.Segments?.[0]?.[0]?.Airline?.AirlineName }} ·
                {{ selectedOutbound?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "EEE, dd MMM y" }} ·
                {{ selectedOutbound?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "HH:mm" }} -
                {{ selectedOutbound?.Segments?.[0]?.[selectedOutbound?.Segments?.[0]?.length - 1]?.Destination?.ArrTime
                | date : "HH:mm" }}
              </span>
              <button class="fare-modify-btn"
                (click)="showModifyForm = !showModifyForm; closeFareOptionsModalBothWay(); $event.stopPropagation()"
                title="Modify">
                <i class="fas fa-edit"></i>
              </button>
            </div>
            <div class="fare-options-subtitle-line" *ngIf="activeFareTab === 'return' && selectedReturn">
              <span class="fare-trip-details-text">
                {{ selectedReturn?.Segments?.[0]?.[0]?.Origin?.Airport?.CityName }} →
                {{ selectedReturn?.Segments?.[0]?.[selectedReturn?.Segments?.[0]?.length -
                1]?.Destination?.Airport?.CityName }} ·
                {{ selectedReturn?.Segments?.[0]?.[0]?.Airline?.AirlineName }} ·
                {{ selectedReturn?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "EEE, dd MMM y" }} ·
                {{ selectedReturn?.Segments?.[0]?.[0]?.Origin?.DepTime | date : "HH:mm" }} -
                {{ selectedReturn?.Segments?.[0]?.[selectedReturn?.Segments?.[0]?.length - 1]?.Destination?.ArrTime |
                date : "HH:mm" }}
              </span>
              <button class="fare-modify-btn"
                (click)="showModifyForm = !showModifyForm; closeFareOptionsModalBothWay(); $event.stopPropagation()"
                title="Modify">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
          <!-- Scrollable Fare Options -->
          <div class="fare-scroll-wrapper">
            <button class="scroll-arrow left" (click)="scrollFareCards('left')">‹</button>
            <div class="fare-scroll-container" #fareScrollContainer>
              <div class="fare-card"
                *ngFor="let fare of activeFareTab === 'departure' ? selectedOutbound?.FareOptions : selectedReturn?.FareOptions; let i = index">
                <div class="fare-price-oneway">
                  ₹ {{ getAdultFarePerPerson(fare.FareBreakdown) | number : "1.0-0" }}
                  <span class="per-adult">per adult</span>
                </div>
                <div class="fare-type">{{ fare.Segments[0][0].SupplierFareClass }}</div>
                <div class="fare-section">
                  <strong>Baggage</strong>
                  <ul>
                    <li>✅ Cabin: {{ fare.Segments[0][0].CabinBaggage }}</li>
                    <li>✅ Check-in: {{ fare.Segments[0][0].Baggage }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Flexibility</strong>
                  <ul>
                    <li>⚠️ Cancel: {{ getCancellationRule(fare) }}</li>
                    <li>⚠️ Change: {{ getDateChangeRule(fare) }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Seats, Meals & More</strong>
                  <ul>
                    <li>🍽️ Meals: {{ fare.IsFreeMealAvailable ? "Free meal available" : "Meal not included" }}</li>
                    <li>💺 Seats: {{ fare.AirlineRemark?.toLowerCase().includes('standard seats are free') ? "Standard
                      seats free" : "Chargeable seats" }}</li>
                    <li>{{ fare.FareRules[0]?.Details || "Check with airline" }}</li>
                  </ul>
                </div>
                <button class="book-btn" (click)="selectFare(activeFareTab, i)"
                  [disabled]="isSelectedFare(activeFareTab, i)">
                  {{ isSelectedFare(activeFareTab, i) ? "SELECTED" : "SELECT" }}
                </button>
              </div>
            </div>
            <button class="scroll-arrow right" (click)="scrollFareCards('right')">›</button>
          </div>
        </div>
        <!-- Footer Summary -->
        <div class="fare-modal-footer">
          <div class="fare-total-block">
            ₹ {{ (selectedOutbound?.price + selectedReturn?.price) | number : "1.0-0" }}<br />
            <span>ROUNDTRIP FOR 1 ADULT</span>
          </div>
          <div class="fare-action-buttons">
            <button class="lock-now-btn">LOCK NOW</button>
            <button class="continue-book-btn"
              [disabled]="(activeFareTab === 'departure' && !hasFareSelected('departure')) || (activeFareTab === 'return' && (!hasFareSelected('departure') || !hasFareSelected('return')))"
              (click)="onFareContinueOrBook()">
              {{ activeFareTab === "departure" ? "CONTINUE" : "BOOK NOW" }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fare Options Modal - Multi-City (Desktop) -->
    <div class="custom-modal-overlay desktop-only" *ngIf="showFareModalMultiCity" (click)="closeFareOptionsModalMultiCity()">
      <div class="custom-modal" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeFareOptionsModalMultiCity()">×</button>
        <div class="fare-options-box">
          <div class="fare-options-header">
            <div class="fare-options-title"><strong>MORE FARE OPTIONS</strong> available for segment {{
              selectedMultiCitySegmentIndex + 1 }}.</div>
            <div class="fare-options-subtitle-line" *ngIf="selectedMultiCityFlight">
              <span class="fare-trip-details-text">{{ selectedMultiCityFlight.Origin.Airport.CityName }} → {{
                selectedMultiCityFlight.Destination.Airport.CityName }} · {{ selectedMultiCityFlight.airline }} · {{
                selectedMultiCityFlight.Origin.DepTime | date : "EEE, dd MMM y" }} · {{
                selectedMultiCityFlight.Origin.DepTime | date : "HH:mm" }} - {{
                selectedMultiCityFlight.Destination.ArrTime | date : "HH:mm" }}</span>
              <button class="fare-modify-btn"
                (click)="showModifyForm = !showModifyForm; closeFareOptionsModalMultiCity(); $event.stopPropagation()"
                title="Modify">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>
          <!-- Scrollable Fare Options -->
          <div class="fare-scroll-wrapper">
            <button class="scroll-arrow left" (click)="scrollFareCards('left')">‹</button>
            <div class="fare-scroll-container" #fareScrollContainer>
              <div class="fare-card" *ngFor="let fare of selectedMultiCityFlight?.FareOptions; let i = index">
                <div class="fare-price-oneway">
                  ₹ {{ getAdultFarePerPerson(fare.FareBreakdown) | number : "1.0-0" }}
                  <span class="per-adult">per adult</span>
                </div>
                <div class="fare-type">{{ fare.Segments[0][0].SupplierFareClass }}</div>
                <div class="fare-section">
                  <strong>Baggage</strong>
                  <ul>
                    <li>✅ Cabin: {{ fare.Segments[0][0].CabinBaggage }}</li>
                    <li>✅ Check-in: {{ fare.Segments[0][0].Baggage }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Flexibility</strong>
                  <ul>
                    <li>⚠️ Cancel: {{ getCancellationRule(fare) }}</li>
                    <li>⚠️ Change: {{ getDateChangeRule(fare) }}</li>
                  </ul>
                </div>
                <div class="fare-section">
                  <strong>Seats, Meals & More</strong>
                  <ul>
                    <li>🍽️ Meals: {{ fare.IsFreeMealAvailable ? "Free meal available" : "Meal not included" }}</li>
                    <li>💺 Seats: {{ fare.AirlineRemark?.toLowerCase().includes('standard seats are free') ? "Standard
                      seats free" : "Chargeable seats" }}</li>
                    <li>{{ fare.FareRules[0]?.Details || "Check with airline" }}</li>
                  </ul>
                </div>
                <button class="book-btn" (click)="selectMulticityFare(fare)">
                  SELECT
                </button>
              </div>
            </div>
            <button class="scroll-arrow right" (click)="scrollFareCards('right')">›</button>
          </div>
        </div>
        <!-- Footer Summary -->
        <div class="fare-modal-footer">
          <div class="fare-total-block">
            ₹ {{ multicityTotalFare | number : "1.0-0" }}<br />
            <span>TOTAL FOR ALL SEGMENTS (1 ADULT)</span>
          </div>
          <div class="fare-action-buttons">
            <button class="continue-book-btn" [class.disabled]="!multicityHasSelectedFares"
              [disabled]="!multicityHasSelectedFares" (click)="proceedWithMultiCityBooking()">
              BOOK NOW
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Fare Options Modal - Multi-City (Mobile - Bottom Sliding) -->
    <div class="fare-popup-overlay-mobile" *ngIf="showFareModalMultiCity" (click)="closeFareOptionsModalMultiCity()"></div>
    <div class="fare-popup animated" *ngIf="showFareModalMultiCity && selectedMultiCityFlight"
      (click)="$event.stopPropagation()">
      <div class="fare-header">
        <span><strong>MORE FARE OPTIONS</strong> available for segment {{ selectedMultiCitySegmentIndex + 1 }}.</span>
        <button (click)="closeFareOptionsModalMultiCity()">×</button>
      </div>
      <div class="fare-body">
        <div class="fare-trip-info" *ngIf="selectedMultiCityFlight" style="padding: 12px 0; border-bottom: 1px solid #eee; margin-bottom: 16px; font-size: 13px; color: #666;">
          {{ selectedMultiCityFlight.Origin.Airport.CityName }} → {{ selectedMultiCityFlight.Destination.Airport.CityName }} · {{ selectedMultiCityFlight.airline }} · {{ selectedMultiCityFlight.Origin.DepTime | date : "EEE, dd MMM y" }} · {{ selectedMultiCityFlight.Origin.DepTime | date : "HH:mm" }} - {{ selectedMultiCityFlight.Destination.ArrTime | date : "HH:mm" }}
        </div>
        <div class="fare-card" *ngFor="let fare of selectedMultiCityFlight?.FareOptions; let i = index">
          <div class="fare-top">
            <div>
              <div class="fare-title">{{ fare.Segments[0][0].SupplierFareClass }}</div>
              <div class="fare-sub">Fare Offered By Airline</div>
            </div>
            <div class="fare-price">
              ₹ {{ getAdultFarePerPerson(fare.FareBreakdown) | number : "1.0-0" }}
              <div class="per">per Adult</div>
            </div>
          </div>
          <div class="fare-detail">
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-suitcase"></i> Cabin Bag
              </div>
              <div class="fare-right">{{ fare.Segments[0][0].CabinBaggage }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-suitcase-rolling"></i> Check-in Bag
              </div>
              <div class="fare-right">{{ fare.Segments[0][0].Baggage }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-times-circle"></i> Cancellation
              </div>
              <div class="fare-right">{{ getCancellationRule(fare) }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-exchange-alt"></i> Date Change
              </div>
              <div class="fare-right">{{ getDateChangeRule(fare) }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-utensils"></i> Meal
              </div>
              <div class="fare-right">{{ fare.IsFreeMealAvailable ? "Free meal available" : "Meal not included" }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-chair"></i> Seat Selection
              </div>
              <div class="fare-right">{{ fare.AirlineRemark?.toLowerCase().includes('standard seats are free') ? "Standard seats free" : "Chargeable seats" }}</div>
            </div>
          </div>
          <button class="book-btn" (click)="selectMulticityFare(fare)">
            SELECT
          </button>
        </div>
        <!-- Footer Summary -->
        <div style="padding: 16px; background: #f9f9f9; border-top: 1px solid #eee; margin-top: 16px;">
          <div style="text-align: center; margin-bottom: 12px;">
            <div style="font-size: 18px; font-weight: bold; color: #333;">
              ₹ {{ multicityTotalFare | number : "1.0-0" }}
            </div>
            <div style="font-size: 12px; color: #666; margin-top: 4px;">
              TOTAL FOR ALL SEGMENTS (1 ADULT)
            </div>
          </div>
          <button class="book-btn" style="background: #28a745; width: 100%;" 
            [class.disabled]="!multicityHasSelectedFares"
            [disabled]="!multicityHasSelectedFares" 
            (click)="proceedWithMultiCityBooking()">
            BOOK NOW
          </button>
        </div>
      </div>
    </div>

    <!-- Mobile Fare Popup (Mobile Only) -->
    <div class="fare-popup-overlay-mobile" *ngIf="showMobileFarePopup" (click)="closeMobileFarePopup()"></div>
    <div class="fare-popup animated" *ngIf="showMobileFarePopup && selectedFlightForMobile"
      (click)="$event.stopPropagation()">
      <div class="fare-header">
        <span>Select Package</span>
        <button (click)="closeMobileFarePopup()">×</button>
      </div>
      <div class="fare-body">
        <div class="fare-card" *ngFor="let fare of defaultFaresForMobile">
          <div class="fare-top">
            <div>
              <div class="fare-title">{{ fare.type }}</div>
              <div class="fare-sub">Fare Offered By Airline</div>
            </div>
            <div class="fare-price">
              ₹ {{ fare.price | number : "1.2-2" }}
              <div class="per">per Adult</div>
            </div>
          </div>
          <div class="fare-detail">
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-suitcase"></i> Cabin Bag
              </div>
              <div class="fare-right">{{ fare.cabin }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-suitcase-rolling"></i> Check-in Bag
              </div>
              <div class="fare-right">{{ fare.checkIn }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-times-circle"></i> Cancellation
              </div>
              <div class="fare-right">{{ fare.cancel }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-exchange-alt"></i> Date Change
              </div>
              <div class="fare-right">{{ fare.dateChange }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-chair"></i> Seat Selection
              </div>
              <div class="fare-right">{{ fare.seat }}</div>
            </div>
            <div class="fare-row">
              <div class="fare-left">
                <i class="fas fa-utensils"></i> Meal
              </div>
              <div class="fare-right">{{ fare.meal }}</div>
            </div>
          </div>
          <button class="book-btn" (click)="finalizeBookingMobile(selectedFlightForMobile, fare)">
            BOOK
          </button>
        </div>
      </div>
    </div>
  </div>
</div>