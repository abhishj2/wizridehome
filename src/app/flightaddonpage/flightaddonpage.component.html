<div class="flightmobaddon-container">
  <!-- Header Card -->
  <div class="flightmobaddon-headercard">
    <span class="flightmobaddon-title">Add Ons</span>
    <button class="flightmobaddon-skip" (click)="onSkipToPayment()">
      Skip to Payment
    </button>
  </div>

  <!-- Content Card -->
  <div class="flightmobaddon-contentcard">
    <!-- Journey Tabs (Onward/Return) for Roundtrip -->
    <div
      class="flightmobaddon-journey-tabs-wrapper"
      *ngIf="tripType === 'roundtrip'"
    >
      <div class="flightmobaddon-journey-tabs">
        <button
          class="flightmobaddon-journey-tab"
          [class.active]="selectedJourneyTab === 'onward'"
          (click)="
            selectedJourneyTab = 'onward';
            selectedSubTabIndex = 0;
            selectedSegmentIndex = 0;
            selectFlight('0')
          "
        >
          Onward
        </button>
        <button
          class="flightmobaddon-journey-tab"
          [class.active]="selectedJourneyTab === 'return'"
          (click)="
            selectedJourneyTab = 'return';
            selectedSubTabIndex = 0;
            selectedSegmentIndex = 0;
            selectFlight(onwardFlights.length.toString())
          "
        >
          Return
        </button>
      </div>
      <div
        class="journey-tab-indicator"
        [ngStyle]="{
          transform:
            'translateX(' + (selectedJourneyTab === 'onward' ? 0 : 100) + '%)'
        }"
      ></div>
    </div>

    <!-- Journey Content Container -->
    <div class="journey-content-container">
      <div
        class="journey-content-wrapper"
        [ngStyle]="{
          transform:
            'translateX(' +
            (tripType === 'roundtrip'
              ? selectedJourneyTab === 'onward'
                ? 0
                : -50
              : 0) +
            '%)',
          '--journey-length': tripType === 'roundtrip' ? 2 : 1
        }"
      >
        <!-- Journey Panel -->
        <div class="journey-panel">
          <ng-container
            *ngIf="tripType !== 'roundtrip' || selectedJourneyTab === 'onward'"
          >
            <!-- Sub-Tabs (Seats, Meals, Cabs, Others) -->
            <div class="flightmobaddon-tabs-wrapper">
              <div class="flightmobaddon-tabs">
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 0"
                  (click)="
                    selectedSubTabIndex = 0;
                    selectedSegmentIndex = 0;
                    selectFlight(
                      (selectedJourneyTab === 'return'
                        ? onwardFlights.length
                        : 0
                      ).toString()
                    )
                  "
                >
                  Seats
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 1"
                  (click)="selectedSubTabIndex = 1; activeMealIndex = 0"
                >
                  Meals
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 2"
                  (click)="selectedSubTabIndex = 2"
                >
                  Cabs
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 3"
                  (click)="selectedSubTabIndex = 3"
                >
                  Others
                </button>
              </div>
              <div
                class="tab-indicator"
                [ngStyle]="{
                  transform: 'translateX(' + selectedSubTabIndex * 100 + '%)'
                }"
              ></div>
            </div>

            <!-- Main Tab Panels Container -->
            <div class="tab-content-container">
              <div
                class="tab-content-wrapper"
                [ngStyle]="{
                  transform:
                    'translateX(-' + selectedSubTabIndex * (100 / 4) + '%)',
                  '--seat-map-length': 4
                }"
              >
                <!-- Seats Tab Panel -->
                <div class="tab-panel">
                  <div class="policy-tabs">
                    <div
                      *ngFor="
                        let flight of selectedJourneyTab === 'return'
                          ? returnFlights
                          : onwardFlights;
                        let i = index
                      "
                      [class.active]="selectedSegmentIndex === i"
                      (click)="
                        selectedSegmentIndex = i; selectFlight(flight.id)
                      "
                    >
                      <img
                        [src]="flight.logo"
                        alt="{{ flight.airlineCode }} logo"
                        width="15"
                        height="15"
                      />
                      <strong>{{ flight.code }}</strong>
                      {{ flight.route }}
                    </div>
                  </div>

                  <!-- Seat Map Panels -->
                  <div class="tab-content-container" *ngIf="(selectedJourneyTab === 'return' ? seatMapReturn : seatMap)?.length">
                    <div
                      class="tab-content-wrapper"
                      [style.transform]="
                        'translateX(-' +
                        selectedSegmentIndex *
                          (100 /
                            (selectedJourneyTab === 'return'
                              ? returnFlights.length
                              : onwardFlights.length)) +
                        '%)'
                      "
                      [style.--seat-map-length]="
                        selectedJourneyTab === 'return'
                          ? returnFlights.length
                          : onwardFlights.length
                      "
                    >
                      <div
                        class="tab-panel"
                        *ngFor="
                          let segment of selectedJourneyTab === 'return'
                            ? seatMapReturn
                            : seatMap;
                          let i = index
                        "
                      >
                        <div class="segment-header-wrapper">
                          <div class="segment-meta">
                            <div class="segment-route">
                              Tap To Select Seats Below
                            </div>
                          </div>
                        </div>
                        <div class="seat-map-wrapper">
                          <div class="legend sticky-legend">
                            <div class="legend-item">
                              <div class="legend-color free"></div>
                              Free
                            </div>
                            <div
                              class="legend-item"
                              *ngFor="let category of segment.priceCategories"
                            >
                              <div
                                class="legend-color"
                                [ngClass]="category.category"
                              ></div>
                              {{
                                category.category === "low-price"
                                  ? "Low"
                                  : category.category === "medium-price"
                                  ? "Medium"
                                  : "High"
                              }}
                              <div
                                *ngIf="category.min !== 0 || category.max !== 0"
                              >
                                ({{ category.min | number : "1.0-0" }} -
                                {{ category.max | number : "1.0-0" }} INR)
                              </div>
                            </div>
                            <div class="legend-item">
                              <div class="legend-color not-available"></div>
                              Not Available
                            </div>
                          </div>
                          <div
                            class="seat-map-scrollable"
                            [style.--seat-count]="
                              getSeatCount(segment.seatBlocks)
                            "
                            [style.--aisle-count]="
                              getAisleCount(segment.seatBlocks)
                            "
                            [style.--block-count]="
                              getBlockCount(segment.seatBlocks)
                            "
                          >
                            <div class="seat-row header-row sticky-header">
                              <div class="row-label-header">Row</div>
                              <ng-container
                                *ngFor="
                                  let block of segment.seatBlocks;
                                  let blockIndex = index
                                "
                              >
                                <div class="seat-block-header">
                                  <div
                                    class="cell-header"
                                    *ngFor="let letter of block"
                                  >
                                    {{ letter }}
                                  </div>
                                </div>
                                <div
                                  class="aisle-divider-header"
                                  *ngIf="
                                    blockIndex < segment.seatBlocks.length - 1
                                  "
                                ></div>
                              </ng-container>
                            </div>
                            <div class="seat-rows-container">
                              <div
                                class="seat-row"
                                *ngFor="let row of segment.rows"
                              >
                                <div class="row-label">{{ row.rowNo }}</div>
                                <ng-container
                                  *ngFor="
                                    let block of row.seatBlocks;
                                    let blockIndex = index
                                  "
                                >
                                  <div class="seat-block">
                                    <div
                                      class="seat-cell"
                                      *ngFor="
                                        let letter of segment.seatBlocks[
                                          blockIndex
                                        ]
                                      "
                                      [ngClass]="{
                                        disabled: !block[letter],
                                        'not-available':
                                          block[letter] &&
                                          !block[letter].isAvailable,
                                        free:
                                          block[letter]?.isAvailable &&
                                          block[letter].priceCategory ===
                                            'free',
                                        'low-price':
                                          block[letter]?.isAvailable &&
                                          block[letter].priceCategory ===
                                            'low-price',
                                        'medium-price':
                                          block[letter]?.isAvailable &&
                                          block[letter].priceCategory ===
                                            'medium-price',
                                        'high-price':
                                          block[letter]?.isAvailable &&
                                          block[letter].priceCategory ===
                                            'high-price',
                                        selected:
                                          block[letter] &&
                                          isSeatSelected(i, block[letter]?.Code)
                                      }"
                                      (click)="
                                        block[letter]?.isAvailable &&
                                          toggleSeatSelection(i, block[letter])
                                      "
                                      [title]="
                                        block[letter]
                                          ? getSeatTooltip(block[letter])
                                          : ''
                                      "
                                    >
                                      <ng-container
                                        *ngIf="block[letter]; else noSeat"
                                      >
                                        <ng-container
                                          *ngIf="
                                            block[letter].priceCategory ===
                                              'free';
                                            else showPrice
                                          "
                                        >
                                          Free
                                        </ng-container>
                                        <ng-template #showPrice>
                                          ₹{{
                                            block[letter].Price
                                              | number : "1.0-0"
                                          }}
                                        </ng-template>
                                      </ng-container>
                                      <ng-template #noSeat>-</ng-template>
                                    </div>
                                  </div>
                                  <div
                                    class="aisle-divider"
                                    *ngIf="
                                      blockIndex < row.seatBlocks.length - 1
                                    "
                                  ></div>
                                </ng-container>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div *ngIf="!(selectedJourneyTab === 'return' ? seatMapReturn : seatMap)?.length" class="centered-message">
                    <p>Seat selection is not available for this flight. Seats will be assigned at check-in.</p>
                  </div>
                </div>

                <!-- Meals Tab Panel -->
                <div class="tab-panel">
                  <div
                    class="tab-content-container"
                    *ngIf="
                      (selectedJourneyTab === 'return'
                        ? flightSegmentsReturn
                        : flightSegments
                      )?.length
                    "
                  >
                    <div class="policy-tabs meal-tabs">
                      <div
                        *ngFor="
                          let flight of selectedJourneyTab === 'return'
                            ? returnFlights
                            : onwardFlights;
                          let i = index
                        "
                        [class.active]="activeMealIndex === i"
                        (click)="activeMealIndex = i"
                      >
                        <img
                          [src]="flight.logo"
                          alt="{{ flight.airlineCode }} logo"
                          width="15"
                          height="15"
                        />
                        <strong>{{ flight.airlineCode }}</strong>
                        {{ flight.route }}
                      </div>
                    </div>
                    <div
                      class="tab-content-wrapper"
                      [style.transform]="
                        'translateX(-' +
                        activeMealIndex *
                          (100 /
                            (selectedJourneyTab === 'return'
                              ? returnFlights.length
                              : onwardFlights.length)) +
                        '%)'
                      "
                      [style.--seat-map-length]="
                        selectedJourneyTab === 'return'
                          ? returnFlights.length
                          : onwardFlights.length
                      "
                    >
                      <div
                        class="tab-panel meal-panel"
                        *ngFor="
                          let segment of selectedJourneyTab === 'return'
                            ? flightSegmentsReturn
                            : flightSegments;
                          let i = index
                        "
                      >
                        <div class="meal-selection">
                          <div
                            *ngIf="(selectedJourneyTab === 'return' ? mealOptionsReturn[i] : mealOptions[i])?.length; else noMeals"
                            class="meal-scroll-container"
                          >
                            <div class="meal-list">
                              <div
                                class="meal-card"
                                *ngFor="let meal of (selectedJourneyTab === 'return' ? mealOptionsReturn[i] : mealOptions[i])"
                              >
                                <div class="meal-visual">
                                  <img
                                    class="meal-image"
                                    src="assets/meals/chicken.png"
                                    alt="Meal"
                                  />
                                  <div class="meal-price">
                                    ₹{{ meal.Price | number : "1.2-2" }}
                                  </div>
                                </div>
                                <div class="meal-details">
                                  <div class="meal-name">
                                    {{
                                      meal.AirlineDescription ||
                                        meal.Description
                                    }}
                                  </div>
                                </div>
                                <div class="meal-quantity">
                                  <button
                                    [disabled]="
                                      getMealCount(i, meal.Code) === 0
                                    "
                                    (click)="decrementMeal(i, meal)"
                                  >
                                    -
                                  </button>
                                  <span>{{ getMealCount(i, meal.Code) }}</span>
                                  <button
                                    [disabled]="
                                      totalSelectedMeals(i) >=
                                      totalAdults + totalChildren
                                    "
                                    (click)="incrementMeal(i, meal)"
                                  >
                                    +
                                  </button>
                                </div>
                              </div>
                            </div>
                            <div class="meal-total">
                              Total Meal Price: ₹{{
                                getSegmentMealTotalPrice(i) | number : "1.2-2"
                              }}
                            </div>
                          </div>
                          <ng-template #noMeals>
                            <p>No meals available for this segment.</p>
                          </ng-template>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Cabs Tab Panel -->
                <div class="tab-panel">
                  <div style="padding: 16px">
                    <h3>Book a Cab</h3>
                    <p>
                      Cab selection UI will go here for
                      {{
                        selectedJourneyTab === "return" ? "Return" : "Onward"
                      }}
                      journey.
                    </p>
                  </div>
                </div>

                <!-- Others Tab Panel -->
                <div class="tab-panel">
                  <div class="meal-selection">
                    <div
                      *ngIf="services?.length; else noServices"
                      class="meal-scroll-container"
                    >
                      <ng-container *ngFor="let service of services">
                        <div
                          class="meal-card"
                          *ngIf="
                            selectedJourneyTab === 'return'
                              ? service.Origin ===
                                  flightSegmentsReturn[0]?.originCode &&
                                service.Destination ===
                                  flightSegmentsReturn[
                                    flightSegmentsReturn.length - 1
                                  ]?.destinationCode
                              : service.Origin ===
                                  flightSegments[0]?.originCode &&
                                service.Destination ===
                                  flightSegments[flightSegments.length - 1]
                                    ?.destinationCode
                          "
                        >
                          <div class="meal-visual">
                            <img
                              class="meal-image"
                              src="assets/meals/special.jpg"
                              alt="Service"
                            />
                            <div class="meal-price">
                              ₹{{ service.Price | number : "1.2-2" }}
                            </div>
                          </div>
                          <div class="meal-details">
                            <div class="meal-name">
                              {{ service.Description }}
                            </div>
                            <div class="meal-route">
                              {{ service.Origin }} - {{ service.Destination }}
                            </div>
                          </div>
                          <div class="meal-quantity">
                            <button
                              *ngIf="getServiceCount(service.Code, service) > 0"
                              (click)="removeService(service)"
                            >
                              −
                            </button>
                            <span>{{
                              getServiceCount(service.Code, service)
                            }}</span>
                            <button
                              [disabled]="
                                getServiceCount(service.Code, service) > 0 ||
                                totalSelectedServices() >=
                                  totalAdults + totalChildren
                              "
                              (click)="addService(service)"
                            >
                              +
                            </button>
                          </div>
                        </div>
                      </ng-container>
                      <div class="meal-total">
                        Total Service Price: ₹{{
                          getServiceTotalPrice() | number : "1.2-2"
                        }}
                      </div>
                    </div>
                    <ng-template #noServices>
                      <p>
                        No services available for this
                        {{
                          selectedJourneyTab === "return" ? "return" : "onward"
                        }}
                        journey.
                      </p>
                    </ng-template>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>

        <!-- Return Journey Panel (for roundtrip) -->
        <div class="journey-panel" *ngIf="tripType === 'roundtrip'">
          <ng-container
            *ngIf="selectedJourneyTab === 'return'"
          >
            <!-- Same structure as onward, but for return journey -->
            <!-- Sub-Tabs (Seats, Meals, Cabs, Others) -->
            <div class="flightmobaddon-tabs-wrapper">
              <div class="flightmobaddon-tabs">
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 0"
                  (click)="
                    selectedSubTabIndex = 0;
                    selectedSegmentIndex = 0;
                    selectFlight(onwardFlights.length.toString())
                  "
                >
                  Seats
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 1"
                  (click)="selectedSubTabIndex = 1; activeMealIndex = 0"
                >
                  Meals
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 2"
                  (click)="selectedSubTabIndex = 2"
                >
                  Cabs
                </button>
                <button
                  class="flightmobaddon-tab"
                  [class.active]="selectedSubTabIndex === 3"
                  (click)="selectedSubTabIndex = 3"
                >
                  Others
                </button>
              </div>
              <div
                class="tab-indicator"
                [ngStyle]="{
                  transform: 'translateX(' + selectedSubTabIndex * 100 + '%)'
                }"
              ></div>
            </div>

            <!-- Main Tab Panels Container (same as onward) -->
            <div class="tab-content-container">
              <div
                class="tab-content-wrapper"
                [ngStyle]="{
                  transform:
                    'translateX(-' + selectedSubTabIndex * (100 / 4) + '%)',
                  '--seat-map-length': 4
                }"
              >
                <!-- Seats, Meals, Cabs, Others panels - same structure as onward -->
                <!-- For brevity, using the same structure but with return data -->
                <div class="tab-panel">
                  <div class="policy-tabs">
                    <div
                      *ngFor="
                        let flight of returnFlights;
                        let i = index
                      "
                      [class.active]="selectedSegmentIndex === i"
                      (click)="
                        selectedSegmentIndex = i; selectFlight(flight.id)
                      "
                    >
                      <img
                        [src]="flight.logo"
                        alt="{{ flight.airlineCode }} logo"
                        width="15"
                        height="15"
                      />
                      <strong>{{ flight.code }}</strong>
                      {{ flight.route }}
                    </div>
                  </div>
                  <div class="tab-content-container" *ngIf="seatMapReturn?.length">
                    <!-- Return seat map - same structure as onward -->
                    <p>Return seat selection (same structure as onward)</p>
                  </div>
                </div>
                <!-- Meals, Cabs, Others tabs for return - same structure -->
              </div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="flightmobaddon-footer">
    <span
      class="flightmobaddon-total"
      (click)="openFareSummary()"
      style="cursor: pointer"
    >
      ₹ Total Price<br />{{ totalPrice | number : "1.2-2" }}
    </span>
    <button class="flightmobaddon-continue" (click)="onContinue()">
      Continue
    </button>
  </div>
</div>

