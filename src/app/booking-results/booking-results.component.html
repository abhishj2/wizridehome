<!-- Compact Search Summary (Desktop Only) -->
<div class="search-summary desktop-search-summary" *ngIf="searchParams">
  <div class="container">
  <div class="summary-content">
   
    <div class="summary-info">
      <div class="route-summary">
        <div class="route-locations">
          <div class="location-group">
            <span class="from">{{ searchParams.from }}</span>
            <span class="location-detail" *ngIf="searchParams.pickupLocation">{{ searchParams.pickupLocation }}</span>
          </div>
          <i class="fas fa-arrow-right"></i>
          <div class="location-group">
            <span class="to">{{ searchParams.to }}</span>
            <span class="location-detail" *ngIf="searchParams.dropLocation">{{ searchParams.dropLocation }}</span>
          </div>
        </div>
        <div class="journey-details">
          <span class="date">{{ formatDate(searchParams.date) }}</span>
          <span class="pickup-time" *ngIf="searchParams?.type === 'reserved' && searchParams?.pickupTime">{{ formatPickupTime(searchParams.pickupTime!) }}</span>
          <span class="passengers">{{ searchParams.passengers }} seats</span>
        </div>
      </div>
    </div>
    <div class="summary-actions">
      <button class="modify-btn" (click)="modifySearch()">Modify</button>
      <button class="request-btn" (click)="requestCarAddition()" *ngIf="searchParams?.type === 'shared'">Request for Addition</button>
      <!-- <button class="modify-btn" (click)="viewAllCarAdditionRequests()" *ngIf="searchParams?.type === 'shared'" style="background: #6c757d;">View Requests</button> -->
    </div>
  </div>
  <div class="container">
    
  </div>
  </div>
</div>

<!-- Tell Us Section -->
<div class="mobile-tell-us-section" *ngIf="searchParams?.type === 'shared'">
  <div class="mobile-tell-us-header">
    <div class="mobile-tell-us-content">
      <h3 class="mobile-tell-us-title">Can't find your timings?</h3>
      <p class="mobile-tell-us-subtitle">If you can't find your required timing below, suggest a preferred timing.</p>
    </div>
    <button class="mobile-tell-us-btn" (click)="requestCarAddition()">Tell Us</button>
  </div>
</div>

<!-- Main Content -->
<main class="results-main">
  <div class="container">
    <div class="results-layout">

      <!-- Vehicle Results -->
      <div class="results-column">
        <!-- <div class="results-header-section">
          <h2 class="results-title">
            {{ searchParams?.type === 'shared' ? 'Shared Cab' : 'Reserved Cab' }} Options
          </h2>
          <p class="results-subtitle">
            {{ vehicleOptions.length }} vehicles available for your journey
          </p>
        </div> -->

        <!-- Loading State -->
        <div class="loading-state" *ngIf="isLoading">
          <div class="loading-spinner"></div>
          <p>Finding the best options for you...</p>
        </div>

        <!-- Vehicle Cards -->
        <div class="vehicle-cards" *ngIf="!isLoading">
          <div class="card" [class.card-expanded]="expandedSections[vehicle.id]" (click)="toggleCardExpansion(vehicle.id, $event)" *ngFor="let vehicle of vehicleOptions">

            <!-- Date Hanger -->
            <div class="date-hanger">
              <div class="date-content">
                <span class="date-text">{{ formatDate(searchParams?.date || '') }}</span>
              </div>
            </div>

            <!-- Route -->
            <ng-container *ngIf="getDepartureDisplay(vehicle) as depTime">
            <div class="route">
              <div class="vehicle">
                <img [src]="vehicle.image" [alt]="vehicle.name">
              </div>

              <div class="route-column">
                <div class="route-code">{{ vehicle.route.from.code }}</div>
                <div class="location">{{ vehicle.route.from.name }}
                  <div class="sub-location" *ngIf="vehicle.pickupLocation">({{ vehicle.pickupLocation }})</div>
                </div>
              </div>

              <div class="route-visualization">
                <div></div>
                <div class="route-line">
                  <div class="route-node start-node"></div>
                  <div class="route-car">
                    <img src="../../assets/images/bgremovecar.png" alt="Car">
                  </div>
                  <div class="route-node end-node"></div>
                </div>
                <div class="route-details">
                  <div class="time">{{ depTime }}</div>
                  <div class="duration">{{ formatDuration(vehicle.duration).replace(' ', '') }}</div>
                </div>
              </div>

              <div class="route-column">
                <div class="route-code">{{ vehicle.route.to.code }}</div>
                <div class="location">{{ vehicle.route.to.name }}
                  <div class="sub-location" *ngIf="vehicle.dropLocation">({{ vehicle.dropLocation }})</div>
                </div>
              </div>

              <div class="price-info">

                <div class="price">₹{{ vehicle.price.toFixed(0) }}</div>
                <div>
                  <p>{{ vehicle.seatsLeft }} Seat Left</p>
                </div>
              </div>
            </div>
            <ng-container *ngIf="computeArrivalTime(depTime, vehicle.duration) as arrivalTime">
              <!-- <div class="mobile-time-row">
                <span class="time-pill start">{{ depTime }}</span>
                <span class="time-pill end">{{ arrivalTime }}</span>
              </div> -->
              <div class="mtrc">
              <div  class="mobile-time-row"><span class="time-pill start">Pickup Time:</span><span class="time-pill end"><i class="fas fa-clock"> </i> {{ depTime }}</span></div>
              </div>  
              
            </ng-container>
            </ng-container>

            <!-- Mobile Amenities + Car Display -->
            <div class="mobile-amenities">
              <div class="amenities-list">
                <div class="amenity">
                  <i class="fas fa-snowflake"></i>
                  <span>Air Conditioned</span>
                </div>
                <div class="amenity">
                  <i class="fas fa-coffee"></i>
                  <span>On-Board Refreshments</span>
                </div>
                <div class="amenity">
                  <i class="fas fa-suitcase-rolling"></i>
                  <span>1 Trolley &amp; 1 Hand Bag per seat</span>
                </div>
              </div>
              <div class="mobile-vehicle-visual">
                <img [src]="vehicle.image" [alt]="vehicle.name">
                <div class="mobile-vehicle-name">{{ vehicle.name }}</div>
              </div>
            </div>

            <!-- Mobile Price Row -->
            <div class="mobile-price-row">
              <div class="mobile-seats-left">
                <img src="../../assets/images/carmodule/seat.png" alt="Seat" class="mobile-seat-icon" />
                <span>Seats Left : {{ vehicle.seatsLeft }}</span>
              </div>
              <div class="mobile-start-price">
                <span>Starts </span>
                <span class="mobile-price">₹ {{ vehicle.price.toFixed(2) }}</span>
              </div>
            </div>

            <!-- Mobile Booking Button -->
            <div class="mobile-booking-row">
              <button class="btn mobile-book-btn"
                      (click)="searchParams?.type === 'shared' ? selectSeat(vehicle) : bookCab(vehicle); $event.stopPropagation()">
                {{ searchParams?.type === 'shared' ? 'Select Seat' : 'Book Cab' }}
              </button>
            </div>

            <!-- Details -->
            <!-- <div class="details">
      <div class="duration">{{ formatDate(searchParams?.date || '') }}</div>
    </div> -->

            <!-- Options -->
            <div class="options">
              <!-- Column 1: AC/Amenities -->
              <div class="option-item">
                <div class="default-amenities">
                  <div class="amenity-item">
                    <i class="fas fa-snowflake"></i>
                    <span>AC</span>
                  </div>
                </div>
                <div class="hover-dropdowns">
                  <div class="dropdown">
                    <i class="fas fa-list-alt"></i>
                    <span>Amenities</span>
                    <div class="dropdown-content">
                      {{ vehicle.amenities.join(', ') }}.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Column 2: Luggage/Instructions -->
              <div class="option-item">
                <div class="default-amenities">
                  <div class="amenity-item">
                    <i class="fas fa-suitcase"></i>
                    <span>Luggage</span>
                  </div>
                </div>
                <div class="hover-dropdowns">
                  <div class="dropdown">
                    <i class="fas fa-info-circle"></i>
                    <span>Instructions</span>
                    <div class="dropdown-content">
                      Arrive 15 minutes before departure. Bring a valid ID. Follow crew instructions.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Column 3: Refreshment/Cancellation Policy -->
              <div class="option-item">
                <div class="default-amenities">
                  <div class="amenity-item">
                    <i class="fas fa-coffee"></i>
                    <span>Refreshment</span>
                  </div>
                </div>
                <div class="hover-dropdowns">
                  <div class="dropdown">
                    <i class="fas fa-ban"></i>
                    <span>Cancellation Policy</span>
                    <div class="dropdown-content">
                      Cancel 24 hours prior for a full refund. 50% refund within 12 hours.
                    </div>
                  </div>
                </div>
              </div>

              <!-- Column 4: Select Seat Button for Shared / Book Cab Button for Reserved -->
              <div class="select-btn-card">
                <button class="btn" (click)="selectSeat(vehicle); $event.stopPropagation()" *ngIf="searchParams?.type === 'shared'">Select Seat</button>
                <button class="btn" (click)="bookCab(vehicle); $event.stopPropagation()" *ngIf="searchParams?.type === 'reserved'">Book Cab</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Promotional Ads -->
      <div class="sidebar-column">
        <div class="promotional-ads">

          <!-- Japan Trip Ad -->
          <div class="ad-card japan-ad">
            <div class="ad-image">
              <img src="https://images.unsplash.com/photo-1493976040374-85c8e12f0c0e?w=300&h=200&fit=crop"
                alt="Japan Trip">
            </div>
            <div class="ad-content">
              <h3 class="ad-title">Japan Trip</h3>
              <p class="ad-description">
                8 Days Trip in September. Come with Us on a Trip of a Lifetime. Check more details.
              </p>
            </div>
          </div>

          <!-- Kazakhstan Ad -->
          <div class="ad-card kazakhstan-ad">
            <div class="ad-image">
              <img src="https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=300&h=200&fit=crop"
                alt="Kazakhstan">
            </div>
            <div class="ad-content">
              <h3 class="ad-title">Kazakhstan</h3>
              <p class="ad-description">
                Explore the beautiful landscapes of Kazakhstan. 10 Days Adventure Package.
              </p>
            </div>
          </div>

          <!-- Europe Tour Ad -->
          <div class="ad-card europe-ad">
            <div class="ad-image">
              <img src="https://images.unsplash.com/photo-1467269204594-9661b134dd2b?w=300&h=200&fit=crop"
                alt="Europe Tour">
            </div>
            <div class="ad-content">
              <h3 class="ad-title">Europe Tour</h3>
              <p class="ad-description">
                Discover the charm of Europe. 15 Days Multi-Country Tour Package.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Car Addition Request Modal -->
<div class="car-addition-modal-overlay" *ngIf="showCarAdditionModal" (click)="closeCarAdditionModal()">
  <div class="car-addition-modal" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <div class="modal-title">
        <h2>Request Car Addition</h2>
        <p>We will try our best to add a car.</p>
      </div>
      <button class="modal-close-btn" (click)="closeCarAdditionModal()">×</button>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      <form class="car-addition-form" (ngSubmit)="submitCarAdditionRequest()" #carAdditionForm="ngForm">
        <!-- Full Name Field -->
        <div class="form-field">
          <label class="field-label">Full Name :</label>
          <input 
            type="text" 
            class="field-input" 
            placeholder="Enter your Full Name."
            [(ngModel)]="carAdditionFormData.fullName"
            name="fullName"
            required
            #fullNameInput="ngModel">
        </div>

        <!-- Contact Number Field -->
        <div class="form-field">
          <label class="field-label">Contact No :</label>
          <input 
            type="tel" 
            class="field-input" 
            placeholder="Enter your Contact Number."
            [(ngModel)]="carAdditionFormData.contactNo"
            name="contactNo"
            required
            #contactNoInput="ngModel">
        </div>

        <!-- Email ID Field -->
        <div class="form-field">
          <label class="field-label">Email ID :</label>
          <input 
            type="email" 
            class="field-input" 
            placeholder="Enter your Email ID."
            [(ngModel)]="carAdditionFormData.emailId"
            name="emailId"
            required
            #emailIdInput="ngModel">
        </div>

        <!-- Preferred Time Field -->
        <div class="form-field">
          <label class="field-label">Preferred Time :</label>
          <div class="time-input-wrapper" (click)="openTimePicker()">
            <input 
              type="text" 
              class="field-input time-display-input" 
              [value]="formatTimeDisplay(carAdditionFormData.preferredTime)"
              placeholder="Select Preferred Time"
              readonly
              name="preferredTime"
              required>
            <i class="fas fa-clock time-icon"></i>
          </div>
          <input type="hidden" [(ngModel)]="carAdditionFormData.preferredTime" name="preferredTimeHidden" required>
        </div>

        <!-- Submit Button -->
        <div class="form-submit">
          <button type="submit" class="submit-btn" [disabled]="!carAdditionForm.valid">
            Send Timing Request
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modern Seat Selection Modal -->
<div class="seat-modal-overlay" *ngIf="showSeatPopup" (click)="closeSeatPopup()">
  <div class="seat-modal" (click)="$event.stopPropagation()">
    <!-- Close Button -->
    <button class="seat-modal-close" (click)="closeSeatPopup()">
      <i class="fas fa-times"></i>
    </button>

    <!-- Modal Header -->
    <div class="seat-modal-header">
      <h2>Choose Your Seat</h2>
      <p>Tap on an available seat to select</p>
    </div>

    <!-- Seat Grid Section -->
    <div class="seat-modal-body">
      <!-- Legend Strip -->
      <div class="seat-legend-strip">
        <div class="legend-chip available">
          <span class="legend-dot"></span>
          <span>Available</span>
        </div>
        <div class="legend-chip selected">
          <span class="legend-dot"></span>
          <span>Selected</span>
        </div>
        <div class="legend-chip booked">
          <span class="legend-dot"></span>
          <span>Booked</span>
        </div>
      </div>

      <!-- Seat Layout Card -->
      <div class="seat-layout-card">
        <!-- Car Background Image -->
        <img src="../../assets/images/carmodule/car2.png" alt="Car" class="seat-car-bg">

        <!-- Seats Grid -->
        <div class="seats-grid">
          <!-- Front Row with Driver -->
          <div class="seat-row-modern front-row-modern">
            <ng-container *ngFor="let seat of frontSeats">
              <div class="seat-item" 
                   [class.seat-available]="seat.status === 'available'"
                   [class.seat-selected]="seat.status === 'selected'"
                   [class.seat-booked]="seat.status === 'booked'"
                   (click)="selectSeatFromPopup(seat)">
                <img src="../../assets/images/carmodule/seat.png" alt="Seat" class="seat-watermark-img">
                <span class="seat-number-big">{{ seat.number }}</span>
              </div>
            </ng-container>
            <!-- Driver Seat -->
            <div class="seat-item">
              <div class="steering-icon"><img src="../../assets/images/carmodule/driver.png" alt="Driver" class="driver-img"></div>
            </div>
          </div>

          <!-- Middle Row -->
          <div class="seat-row-modern middle-row-modern">
            <ng-container *ngFor="let seat of middleSeats">
              <div class="seat-item" 
                   [class.seat-available]="seat.status === 'available'"
                   [class.seat-selected]="seat.status === 'selected'"
                   [class.seat-booked]="seat.status === 'booked'"
                   (click)="selectSeatFromPopup(seat)">
                <img src="../../assets/images/carmodule/seat.png" alt="Seat" class="seat-watermark-img">
                <span class="seat-number-big">{{ seat.number }}</span>
              </div>
            </ng-container>
          </div>

          <!-- Back Row -->
          <div class="seat-row-modern back-row-modern">
            <ng-container *ngFor="let seat of backSeats">
              <div class="seat-item" 
                   [class.seat-available]="seat.status === 'available'"
                   [class.seat-selected]="seat.status === 'selected'"
                   [class.seat-booked]="seat.status === 'booked'"
                   (click)="selectSeatFromPopup(seat)">
                <img src="../../assets/images/carmodule/seat.png" alt="Seat" class="seat-watermark-img">
                <span class="seat-number-big">{{ seat.number }}</span>
              </div>
            </ng-container>
          </div>
        </div>
      </div>

      <!-- Selection Summary -->
      <div class="seat-selection-summary" *ngIf="selectedSeats.length > 0">
        <div class="summary-row">
          <span class="summary-label">Selected Seats</span>
          <span class="summary-value">{{ selectedSeats.length }}</span>
        </div>
        <div class="summary-row total">
          <span class="summary-label">Total Amount</span>
          <span class="summary-value">₹{{ getTotalPrice() }}</span>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="seat-modal-footer">
      <button class="seat-proceed-btn" (click)="proceedToBooking()" [disabled]="selectedSeats.length === 0">
        <span>Continue to Booking</span>
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </div>
</div>

<!-- Time Picker Modal -->
<div class="time-picker-overlay" [class.active]="timePickerVisible" (click)="closeTimePicker()">
  <div class="time-picker-modal" (click)="$event.stopPropagation()">
    <div class="time-picker-header">
      <h3>Select Preferred Time</h3>
      <button class="close-btn" (click)="closeTimePicker()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="time-picker-content">
      <div class="time-columns">
        <!-- Hours Column -->
        <div class="time-column">
          <div class="column-header">Hrs</div>
          <div class="time-scroll-container">
            <div class="time-options" #hoursContainer>
              <div class="time-option" 
                   *ngFor="let hour of hours" 
                   [class.selected]="selectedHour === hour"
                   (click)="selectHour(hour)">
                {{hour}}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Minutes Column -->
        <div class="time-column">
          <div class="column-header">Min</div>
          <div class="time-scroll-container">
            <div class="time-options">
              <div class="time-option" 
                   *ngFor="let minute of minutes" 
                   [class.selected]="selectedMinute === minute"
                   (click)="selectMinute(minute)">
                {{minute}}
              </div>
            </div>
          </div>
        </div>
        
        <!-- AM/PM Column -->
        <div class="time-column">
          <div class="column-header">A.M/ P.M</div>
          <div class="time-scroll-container">
            <div class="time-options">
              <div class="time-option" 
                   [class.selected]="selectedPeriod === 'AM'"
                   (click)="selectPeriod('AM')">
                A.M.
              </div>
              <div class="time-option" 
                   [class.selected]="selectedPeriod === 'PM'"
                   (click)="selectPeriod('PM')">
                P.M.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="time-picker-footer">
      <button class="done-btn" (click)="confirmTimeSelection()">
        Done
      </button>
    </div>
  </div>
</div>